
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="..">
      
      
      
        
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1">
    
    
      
        <title>API Reference - UrbanOPT Documentation</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="blue-grey" data-md-color-accent="green">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#api-reference" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="UrbanOPT Documentation" class="md-header__button md-logo" aria-label="UrbanOPT Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            UrbanOPT Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              API Reference
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="blue-grey" data-md-color-accent="green"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="blue-grey" data-md-color-accent="green"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="UrbanOPT Documentation" class="md-nav__button md-logo" aria-label="UrbanOPT Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    UrbanOPT Documentation
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Getting Started
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Tutorials
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Tutorials
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tutorial_1.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Tutorial 1
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tutorial_2.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Tutorial 2
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    API Reference
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    API Reference
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#urbanopt.PathwayOptimizer" class="md-nav__link">
    <span class="md-ellipsis">
      
        PathwayOptimizer
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#urbanopt.PathwayOptimizer.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __init__
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#urbanopt.PathwayOptimizer.add_contribution_constraints" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_contribution_constraints
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#urbanopt.PathwayOptimizer.add_conversion_constraints" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_conversion_constraints
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#urbanopt.PathwayOptimizer.add_max_contribution_near_point" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_max_contribution_near_point
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#urbanopt.PathwayOptimizer.add_mutual_exclusion" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_mutual_exclusion
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#urbanopt.PathwayOptimizer.add_zone_difference_constraints" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_zone_difference_constraints
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#urbanopt.PathwayOptimizer.build_variables" class="md-nav__link">
    <span class="md-ellipsis">
      
        build_variables
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#urbanopt.PathwayOptimizer.debug_model" class="md-nav__link">
    <span class="md-ellipsis">
      
        debug_model
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#urbanopt.PathwayOptimizer.export_model" class="md-nav__link">
    <span class="md-ellipsis">
      
        export_model
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#urbanopt.PathwayOptimizer.get_selected_pids" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_selected_pids
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#urbanopt.PathwayOptimizer.get_solution_summary" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_solution_summary
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#urbanopt.PathwayOptimizer.load" class="md-nav__link">
    <span class="md-ellipsis">
      
        load
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#urbanopt.PathwayOptimizer.print_solution_summary" class="md-nav__link">
    <span class="md-ellipsis">
      
        print_solution_summary
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#urbanopt.PathwayOptimizer.remove_constraints" class="md-nav__link">
    <span class="md-ellipsis">
      
        remove_constraints
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#urbanopt.PathwayOptimizer.save" class="md-nav__link">
    <span class="md-ellipsis">
      
        save
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#urbanopt.PathwayOptimizer.set_objective" class="md-nav__link">
    <span class="md-ellipsis">
      
        set_objective
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#urbanopt.PathwayOptimizer.solve" class="md-nav__link">
    <span class="md-ellipsis">
      
        solve
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#urbanopt.PathwayOptimizer" class="md-nav__link">
    <span class="md-ellipsis">
      
        PathwayOptimizer
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#urbanopt.PathwayOptimizer.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __init__
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#urbanopt.PathwayOptimizer.add_contribution_constraints" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_contribution_constraints
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#urbanopt.PathwayOptimizer.add_conversion_constraints" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_conversion_constraints
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#urbanopt.PathwayOptimizer.add_max_contribution_near_point" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_max_contribution_near_point
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#urbanopt.PathwayOptimizer.add_mutual_exclusion" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_mutual_exclusion
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#urbanopt.PathwayOptimizer.add_zone_difference_constraints" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_zone_difference_constraints
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#urbanopt.PathwayOptimizer.build_variables" class="md-nav__link">
    <span class="md-ellipsis">
      
        build_variables
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#urbanopt.PathwayOptimizer.debug_model" class="md-nav__link">
    <span class="md-ellipsis">
      
        debug_model
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#urbanopt.PathwayOptimizer.export_model" class="md-nav__link">
    <span class="md-ellipsis">
      
        export_model
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#urbanopt.PathwayOptimizer.get_selected_pids" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_selected_pids
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#urbanopt.PathwayOptimizer.get_solution_summary" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_solution_summary
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#urbanopt.PathwayOptimizer.load" class="md-nav__link">
    <span class="md-ellipsis">
      
        load
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#urbanopt.PathwayOptimizer.print_solution_summary" class="md-nav__link">
    <span class="md-ellipsis">
      
        print_solution_summary
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#urbanopt.PathwayOptimizer.remove_constraints" class="md-nav__link">
    <span class="md-ellipsis">
      
        remove_constraints
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#urbanopt.PathwayOptimizer.save" class="md-nav__link">
    <span class="md-ellipsis">
      
        save
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#urbanopt.PathwayOptimizer.set_objective" class="md-nav__link">
    <span class="md-ellipsis">
      
        set_objective
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#urbanopt.PathwayOptimizer.solve" class="md-nav__link">
    <span class="md-ellipsis">
      
        solve
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="api-reference">API Reference</h1>


<div class="doc doc-object doc-class">



<a id="urbanopt.PathwayOptimizer"></a>
    <div class="doc doc-contents first">



        <p>Optimizer for housing pathway selection based on multiple criteria.</p>
<p>This class provides functionality to optimize pathway selection using Gurobi,
allowing for various constraints and objectives to be defined. It supports
spatial filtering through boundary polygons and flexible constraint tagging
for organization.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="urbanopt.PathwayOptimizer.data">data</span></code></td>
            <td>
                  <code><span title="geopandas.GeoDataFrame">GeoDataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Copy of input GeoDataFrame with pathway data.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="urbanopt.PathwayOptimizer.crs">crs</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Coordinate reference system from input GeoDataFrame.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="urbanopt.PathwayOptimizer.pids">pids</span></code></td>
            <td>
                  <code><span title="list">list</span>[<span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of pathway IDs.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="urbanopt.PathwayOptimizer.cost_columns">cost_columns</span></code></td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of cost-related column names.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="urbanopt.PathwayOptimizer.model">model</span></code></td>
            <td>
                  <code><span title="gurobipy.Model">Model</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Gurobi optimization model (initialized by build_variables).</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>
        <!--
Internal Attributes:
    _variables (dict[str, gp.Var]): Dictionary mapping variable names to Gurobi variables.
        (initialized by build_variables).
    _constraints (dict[str, list[gp.Constr]]): Dictionary mapping tags to lists of constraints.
    _gindex_to_pid (dict[int, int]): Dictionary mapping gurobi variable indices to pathway IDs.
    _pid_to_gindex (dict[int, int]): Dictionary mapping pathway ID to gurobi variable indices.
    _objective_weights (dict[str, float]): Dictionary mapping cost column names to their weights
        in the objective function.
    _has_dummies (bool): True if dummy "z" variables have been added to the problem (e.g. via add_conversion_constraints)
-->


<p><span class="doc-section-title">Examples:</span></p>
    <p>Basic usage with a GeoDataFrame:</p>
<pre><code class="language-python">import geopandas as gpd
from shapely.geometry import Point

# Setup dummy data
data = {
    &quot;pid&quot;: [1, 2, 3],
    &quot;start&quot;: [&quot;A&quot;, &quot;B&quot;, &quot;C&quot;],
    &quot;end&quot;: [&quot;X&quot;, &quot;Y&quot;, &quot;Z&quot;],
    &quot;desc&quot;: [&quot;desc1&quot;, &quot;desc2&quot;, &quot;desc3&quot;],
    &quot;contribution&quot;: [1.0, 2.0, 3.0],
    &quot;geometry&quot;: [Point(0, 0), Point(1, 1), Point(2, 2)],
    &quot;cost_emb&quot;: [10, 20, 30],
    &quot;cost_transit&quot;: [5, 15, 25]
}
gdf = gpd.GeoDataFrame(data, crs=&quot;EPSG:4326&quot;)

# Initialize and run optimizer
optimizer = PathwayOptimizer(gdf)
optimizer.build_variables()
optimizer.set_objective({&quot;cost_emb&quot;: 1.0, &quot;cost_transit&quot;: 0.5})
optimizer.add_contribution_constraints(3.0, tag=&quot;constraints&quot;)
</code></pre>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>urbanopt\core.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">  36</span>
<span class="normal">  37</span>
<span class="normal">  38</span>
<span class="normal">  39</span>
<span class="normal">  40</span>
<span class="normal">  41</span>
<span class="normal">  42</span>
<span class="normal">  43</span>
<span class="normal">  44</span>
<span class="normal">  45</span>
<span class="normal">  46</span>
<span class="normal">  47</span>
<span class="normal">  48</span>
<span class="normal">  49</span>
<span class="normal">  50</span>
<span class="normal">  51</span>
<span class="normal">  52</span>
<span class="normal">  53</span>
<span class="normal">  54</span>
<span class="normal">  55</span>
<span class="normal">  56</span>
<span class="normal">  57</span>
<span class="normal">  58</span>
<span class="normal">  59</span>
<span class="normal">  60</span>
<span class="normal">  61</span>
<span class="normal">  62</span>
<span class="normal">  63</span>
<span class="normal">  64</span>
<span class="normal">  65</span>
<span class="normal">  66</span>
<span class="normal">  67</span>
<span class="normal">  68</span>
<span class="normal">  69</span>
<span class="normal">  70</span>
<span class="normal">  71</span>
<span class="normal">  72</span>
<span class="normal">  73</span>
<span class="normal">  74</span>
<span class="normal">  75</span>
<span class="normal">  76</span>
<span class="normal">  77</span>
<span class="normal">  78</span>
<span class="normal">  79</span>
<span class="normal">  80</span>
<span class="normal">  81</span>
<span class="normal">  82</span>
<span class="normal">  83</span>
<span class="normal">  84</span>
<span class="normal">  85</span>
<span class="normal">  86</span>
<span class="normal">  87</span>
<span class="normal">  88</span>
<span class="normal">  89</span>
<span class="normal">  90</span>
<span class="normal">  91</span>
<span class="normal">  92</span>
<span class="normal">  93</span>
<span class="normal">  94</span>
<span class="normal">  95</span>
<span class="normal">  96</span>
<span class="normal">  97</span>
<span class="normal">  98</span>
<span class="normal">  99</span>
<span class="normal"> 100</span>
<span class="normal"> 101</span>
<span class="normal"> 102</span>
<span class="normal"> 103</span>
<span class="normal"> 104</span>
<span class="normal"> 105</span>
<span class="normal"> 106</span>
<span class="normal"> 107</span>
<span class="normal"> 108</span>
<span class="normal"> 109</span>
<span class="normal"> 110</span>
<span class="normal"> 111</span>
<span class="normal"> 112</span>
<span class="normal"> 113</span>
<span class="normal"> 114</span>
<span class="normal"> 115</span>
<span class="normal"> 116</span>
<span class="normal"> 117</span>
<span class="normal"> 118</span>
<span class="normal"> 119</span>
<span class="normal"> 120</span>
<span class="normal"> 121</span>
<span class="normal"> 122</span>
<span class="normal"> 123</span>
<span class="normal"> 124</span>
<span class="normal"> 125</span>
<span class="normal"> 126</span>
<span class="normal"> 127</span>
<span class="normal"> 128</span>
<span class="normal"> 129</span>
<span class="normal"> 130</span>
<span class="normal"> 131</span>
<span class="normal"> 132</span>
<span class="normal"> 133</span>
<span class="normal"> 134</span>
<span class="normal"> 135</span>
<span class="normal"> 136</span>
<span class="normal"> 137</span>
<span class="normal"> 138</span>
<span class="normal"> 139</span>
<span class="normal"> 140</span>
<span class="normal"> 141</span>
<span class="normal"> 142</span>
<span class="normal"> 143</span>
<span class="normal"> 144</span>
<span class="normal"> 145</span>
<span class="normal"> 146</span>
<span class="normal"> 147</span>
<span class="normal"> 148</span>
<span class="normal"> 149</span>
<span class="normal"> 150</span>
<span class="normal"> 151</span>
<span class="normal"> 152</span>
<span class="normal"> 153</span>
<span class="normal"> 154</span>
<span class="normal"> 155</span>
<span class="normal"> 156</span>
<span class="normal"> 157</span>
<span class="normal"> 158</span>
<span class="normal"> 159</span>
<span class="normal"> 160</span>
<span class="normal"> 161</span>
<span class="normal"> 162</span>
<span class="normal"> 163</span>
<span class="normal"> 164</span>
<span class="normal"> 165</span>
<span class="normal"> 166</span>
<span class="normal"> 167</span>
<span class="normal"> 168</span>
<span class="normal"> 169</span>
<span class="normal"> 170</span>
<span class="normal"> 171</span>
<span class="normal"> 172</span>
<span class="normal"> 173</span>
<span class="normal"> 174</span>
<span class="normal"> 175</span>
<span class="normal"> 176</span>
<span class="normal"> 177</span>
<span class="normal"> 178</span>
<span class="normal"> 179</span>
<span class="normal"> 180</span>
<span class="normal"> 181</span>
<span class="normal"> 182</span>
<span class="normal"> 183</span>
<span class="normal"> 184</span>
<span class="normal"> 185</span>
<span class="normal"> 186</span>
<span class="normal"> 187</span>
<span class="normal"> 188</span>
<span class="normal"> 189</span>
<span class="normal"> 190</span>
<span class="normal"> 191</span>
<span class="normal"> 192</span>
<span class="normal"> 193</span>
<span class="normal"> 194</span>
<span class="normal"> 195</span>
<span class="normal"> 196</span>
<span class="normal"> 197</span>
<span class="normal"> 198</span>
<span class="normal"> 199</span>
<span class="normal"> 200</span>
<span class="normal"> 201</span>
<span class="normal"> 202</span>
<span class="normal"> 203</span>
<span class="normal"> 204</span>
<span class="normal"> 205</span>
<span class="normal"> 206</span>
<span class="normal"> 207</span>
<span class="normal"> 208</span>
<span class="normal"> 209</span>
<span class="normal"> 210</span>
<span class="normal"> 211</span>
<span class="normal"> 212</span>
<span class="normal"> 213</span>
<span class="normal"> 214</span>
<span class="normal"> 215</span>
<span class="normal"> 216</span>
<span class="normal"> 217</span>
<span class="normal"> 218</span>
<span class="normal"> 219</span>
<span class="normal"> 220</span>
<span class="normal"> 221</span>
<span class="normal"> 222</span>
<span class="normal"> 223</span>
<span class="normal"> 224</span>
<span class="normal"> 225</span>
<span class="normal"> 226</span>
<span class="normal"> 227</span>
<span class="normal"> 228</span>
<span class="normal"> 229</span>
<span class="normal"> 230</span>
<span class="normal"> 231</span>
<span class="normal"> 232</span>
<span class="normal"> 233</span>
<span class="normal"> 234</span>
<span class="normal"> 235</span>
<span class="normal"> 236</span>
<span class="normal"> 237</span>
<span class="normal"> 238</span>
<span class="normal"> 239</span>
<span class="normal"> 240</span>
<span class="normal"> 241</span>
<span class="normal"> 242</span>
<span class="normal"> 243</span>
<span class="normal"> 244</span>
<span class="normal"> 245</span>
<span class="normal"> 246</span>
<span class="normal"> 247</span>
<span class="normal"> 248</span>
<span class="normal"> 249</span>
<span class="normal"> 250</span>
<span class="normal"> 251</span>
<span class="normal"> 252</span>
<span class="normal"> 253</span>
<span class="normal"> 254</span>
<span class="normal"> 255</span>
<span class="normal"> 256</span>
<span class="normal"> 257</span>
<span class="normal"> 258</span>
<span class="normal"> 259</span>
<span class="normal"> 260</span>
<span class="normal"> 261</span>
<span class="normal"> 262</span>
<span class="normal"> 263</span>
<span class="normal"> 264</span>
<span class="normal"> 265</span>
<span class="normal"> 266</span>
<span class="normal"> 267</span>
<span class="normal"> 268</span>
<span class="normal"> 269</span>
<span class="normal"> 270</span>
<span class="normal"> 271</span>
<span class="normal"> 272</span>
<span class="normal"> 273</span>
<span class="normal"> 274</span>
<span class="normal"> 275</span>
<span class="normal"> 276</span>
<span class="normal"> 277</span>
<span class="normal"> 278</span>
<span class="normal"> 279</span>
<span class="normal"> 280</span>
<span class="normal"> 281</span>
<span class="normal"> 282</span>
<span class="normal"> 283</span>
<span class="normal"> 284</span>
<span class="normal"> 285</span>
<span class="normal"> 286</span>
<span class="normal"> 287</span>
<span class="normal"> 288</span>
<span class="normal"> 289</span>
<span class="normal"> 290</span>
<span class="normal"> 291</span>
<span class="normal"> 292</span>
<span class="normal"> 293</span>
<span class="normal"> 294</span>
<span class="normal"> 295</span>
<span class="normal"> 296</span>
<span class="normal"> 297</span>
<span class="normal"> 298</span>
<span class="normal"> 299</span>
<span class="normal"> 300</span>
<span class="normal"> 301</span>
<span class="normal"> 302</span>
<span class="normal"> 303</span>
<span class="normal"> 304</span>
<span class="normal"> 305</span>
<span class="normal"> 306</span>
<span class="normal"> 307</span>
<span class="normal"> 308</span>
<span class="normal"> 309</span>
<span class="normal"> 310</span>
<span class="normal"> 311</span>
<span class="normal"> 312</span>
<span class="normal"> 313</span>
<span class="normal"> 314</span>
<span class="normal"> 315</span>
<span class="normal"> 316</span>
<span class="normal"> 317</span>
<span class="normal"> 318</span>
<span class="normal"> 319</span>
<span class="normal"> 320</span>
<span class="normal"> 321</span>
<span class="normal"> 322</span>
<span class="normal"> 323</span>
<span class="normal"> 324</span>
<span class="normal"> 325</span>
<span class="normal"> 326</span>
<span class="normal"> 327</span>
<span class="normal"> 328</span>
<span class="normal"> 329</span>
<span class="normal"> 330</span>
<span class="normal"> 331</span>
<span class="normal"> 332</span>
<span class="normal"> 333</span>
<span class="normal"> 334</span>
<span class="normal"> 335</span>
<span class="normal"> 336</span>
<span class="normal"> 337</span>
<span class="normal"> 338</span>
<span class="normal"> 339</span>
<span class="normal"> 340</span>
<span class="normal"> 341</span>
<span class="normal"> 342</span>
<span class="normal"> 343</span>
<span class="normal"> 344</span>
<span class="normal"> 345</span>
<span class="normal"> 346</span>
<span class="normal"> 347</span>
<span class="normal"> 348</span>
<span class="normal"> 349</span>
<span class="normal"> 350</span>
<span class="normal"> 351</span>
<span class="normal"> 352</span>
<span class="normal"> 353</span>
<span class="normal"> 354</span>
<span class="normal"> 355</span>
<span class="normal"> 356</span>
<span class="normal"> 357</span>
<span class="normal"> 358</span>
<span class="normal"> 359</span>
<span class="normal"> 360</span>
<span class="normal"> 361</span>
<span class="normal"> 362</span>
<span class="normal"> 363</span>
<span class="normal"> 364</span>
<span class="normal"> 365</span>
<span class="normal"> 366</span>
<span class="normal"> 367</span>
<span class="normal"> 368</span>
<span class="normal"> 369</span>
<span class="normal"> 370</span>
<span class="normal"> 371</span>
<span class="normal"> 372</span>
<span class="normal"> 373</span>
<span class="normal"> 374</span>
<span class="normal"> 375</span>
<span class="normal"> 376</span>
<span class="normal"> 377</span>
<span class="normal"> 378</span>
<span class="normal"> 379</span>
<span class="normal"> 380</span>
<span class="normal"> 381</span>
<span class="normal"> 382</span>
<span class="normal"> 383</span>
<span class="normal"> 384</span>
<span class="normal"> 385</span>
<span class="normal"> 386</span>
<span class="normal"> 387</span>
<span class="normal"> 388</span>
<span class="normal"> 389</span>
<span class="normal"> 390</span>
<span class="normal"> 391</span>
<span class="normal"> 392</span>
<span class="normal"> 393</span>
<span class="normal"> 394</span>
<span class="normal"> 395</span>
<span class="normal"> 396</span>
<span class="normal"> 397</span>
<span class="normal"> 398</span>
<span class="normal"> 399</span>
<span class="normal"> 400</span>
<span class="normal"> 401</span>
<span class="normal"> 402</span>
<span class="normal"> 403</span>
<span class="normal"> 404</span>
<span class="normal"> 405</span>
<span class="normal"> 406</span>
<span class="normal"> 407</span>
<span class="normal"> 408</span>
<span class="normal"> 409</span>
<span class="normal"> 410</span>
<span class="normal"> 411</span>
<span class="normal"> 412</span>
<span class="normal"> 413</span>
<span class="normal"> 414</span>
<span class="normal"> 415</span>
<span class="normal"> 416</span>
<span class="normal"> 417</span>
<span class="normal"> 418</span>
<span class="normal"> 419</span>
<span class="normal"> 420</span>
<span class="normal"> 421</span>
<span class="normal"> 422</span>
<span class="normal"> 423</span>
<span class="normal"> 424</span>
<span class="normal"> 425</span>
<span class="normal"> 426</span>
<span class="normal"> 427</span>
<span class="normal"> 428</span>
<span class="normal"> 429</span>
<span class="normal"> 430</span>
<span class="normal"> 431</span>
<span class="normal"> 432</span>
<span class="normal"> 433</span>
<span class="normal"> 434</span>
<span class="normal"> 435</span>
<span class="normal"> 436</span>
<span class="normal"> 437</span>
<span class="normal"> 438</span>
<span class="normal"> 439</span>
<span class="normal"> 440</span>
<span class="normal"> 441</span>
<span class="normal"> 442</span>
<span class="normal"> 443</span>
<span class="normal"> 444</span>
<span class="normal"> 445</span>
<span class="normal"> 446</span>
<span class="normal"> 447</span>
<span class="normal"> 448</span>
<span class="normal"> 449</span>
<span class="normal"> 450</span>
<span class="normal"> 451</span>
<span class="normal"> 452</span>
<span class="normal"> 453</span>
<span class="normal"> 454</span>
<span class="normal"> 455</span>
<span class="normal"> 456</span>
<span class="normal"> 457</span>
<span class="normal"> 458</span>
<span class="normal"> 459</span>
<span class="normal"> 460</span>
<span class="normal"> 461</span>
<span class="normal"> 462</span>
<span class="normal"> 463</span>
<span class="normal"> 464</span>
<span class="normal"> 465</span>
<span class="normal"> 466</span>
<span class="normal"> 467</span>
<span class="normal"> 468</span>
<span class="normal"> 469</span>
<span class="normal"> 470</span>
<span class="normal"> 471</span>
<span class="normal"> 472</span>
<span class="normal"> 473</span>
<span class="normal"> 474</span>
<span class="normal"> 475</span>
<span class="normal"> 476</span>
<span class="normal"> 477</span>
<span class="normal"> 478</span>
<span class="normal"> 479</span>
<span class="normal"> 480</span>
<span class="normal"> 481</span>
<span class="normal"> 482</span>
<span class="normal"> 483</span>
<span class="normal"> 484</span>
<span class="normal"> 485</span>
<span class="normal"> 486</span>
<span class="normal"> 487</span>
<span class="normal"> 488</span>
<span class="normal"> 489</span>
<span class="normal"> 490</span>
<span class="normal"> 491</span>
<span class="normal"> 492</span>
<span class="normal"> 493</span>
<span class="normal"> 494</span>
<span class="normal"> 495</span>
<span class="normal"> 496</span>
<span class="normal"> 497</span>
<span class="normal"> 498</span>
<span class="normal"> 499</span>
<span class="normal"> 500</span>
<span class="normal"> 501</span>
<span class="normal"> 502</span>
<span class="normal"> 503</span>
<span class="normal"> 504</span>
<span class="normal"> 505</span>
<span class="normal"> 506</span>
<span class="normal"> 507</span>
<span class="normal"> 508</span>
<span class="normal"> 509</span>
<span class="normal"> 510</span>
<span class="normal"> 511</span>
<span class="normal"> 512</span>
<span class="normal"> 513</span>
<span class="normal"> 514</span>
<span class="normal"> 515</span>
<span class="normal"> 516</span>
<span class="normal"> 517</span>
<span class="normal"> 518</span>
<span class="normal"> 519</span>
<span class="normal"> 520</span>
<span class="normal"> 521</span>
<span class="normal"> 522</span>
<span class="normal"> 523</span>
<span class="normal"> 524</span>
<span class="normal"> 525</span>
<span class="normal"> 526</span>
<span class="normal"> 527</span>
<span class="normal"> 528</span>
<span class="normal"> 529</span>
<span class="normal"> 530</span>
<span class="normal"> 531</span>
<span class="normal"> 532</span>
<span class="normal"> 533</span>
<span class="normal"> 534</span>
<span class="normal"> 535</span>
<span class="normal"> 536</span>
<span class="normal"> 537</span>
<span class="normal"> 538</span>
<span class="normal"> 539</span>
<span class="normal"> 540</span>
<span class="normal"> 541</span>
<span class="normal"> 542</span>
<span class="normal"> 543</span>
<span class="normal"> 544</span>
<span class="normal"> 545</span>
<span class="normal"> 546</span>
<span class="normal"> 547</span>
<span class="normal"> 548</span>
<span class="normal"> 549</span>
<span class="normal"> 550</span>
<span class="normal"> 551</span>
<span class="normal"> 552</span>
<span class="normal"> 553</span>
<span class="normal"> 554</span>
<span class="normal"> 555</span>
<span class="normal"> 556</span>
<span class="normal"> 557</span>
<span class="normal"> 558</span>
<span class="normal"> 559</span>
<span class="normal"> 560</span>
<span class="normal"> 561</span>
<span class="normal"> 562</span>
<span class="normal"> 563</span>
<span class="normal"> 564</span>
<span class="normal"> 565</span>
<span class="normal"> 566</span>
<span class="normal"> 567</span>
<span class="normal"> 568</span>
<span class="normal"> 569</span>
<span class="normal"> 570</span>
<span class="normal"> 571</span>
<span class="normal"> 572</span>
<span class="normal"> 573</span>
<span class="normal"> 574</span>
<span class="normal"> 575</span>
<span class="normal"> 576</span>
<span class="normal"> 577</span>
<span class="normal"> 578</span>
<span class="normal"> 579</span>
<span class="normal"> 580</span>
<span class="normal"> 581</span>
<span class="normal"> 582</span>
<span class="normal"> 583</span>
<span class="normal"> 584</span>
<span class="normal"> 585</span>
<span class="normal"> 586</span>
<span class="normal"> 587</span>
<span class="normal"> 588</span>
<span class="normal"> 589</span>
<span class="normal"> 590</span>
<span class="normal"> 591</span>
<span class="normal"> 592</span>
<span class="normal"> 593</span>
<span class="normal"> 594</span>
<span class="normal"> 595</span>
<span class="normal"> 596</span>
<span class="normal"> 597</span>
<span class="normal"> 598</span>
<span class="normal"> 599</span>
<span class="normal"> 600</span>
<span class="normal"> 601</span>
<span class="normal"> 602</span>
<span class="normal"> 603</span>
<span class="normal"> 604</span>
<span class="normal"> 605</span>
<span class="normal"> 606</span>
<span class="normal"> 607</span>
<span class="normal"> 608</span>
<span class="normal"> 609</span>
<span class="normal"> 610</span>
<span class="normal"> 611</span>
<span class="normal"> 612</span>
<span class="normal"> 613</span>
<span class="normal"> 614</span>
<span class="normal"> 615</span>
<span class="normal"> 616</span>
<span class="normal"> 617</span>
<span class="normal"> 618</span>
<span class="normal"> 619</span>
<span class="normal"> 620</span>
<span class="normal"> 621</span>
<span class="normal"> 622</span>
<span class="normal"> 623</span>
<span class="normal"> 624</span>
<span class="normal"> 625</span>
<span class="normal"> 626</span>
<span class="normal"> 627</span>
<span class="normal"> 628</span>
<span class="normal"> 629</span>
<span class="normal"> 630</span>
<span class="normal"> 631</span>
<span class="normal"> 632</span>
<span class="normal"> 633</span>
<span class="normal"> 634</span>
<span class="normal"> 635</span>
<span class="normal"> 636</span>
<span class="normal"> 637</span>
<span class="normal"> 638</span>
<span class="normal"> 639</span>
<span class="normal"> 640</span>
<span class="normal"> 641</span>
<span class="normal"> 642</span>
<span class="normal"> 643</span>
<span class="normal"> 644</span>
<span class="normal"> 645</span>
<span class="normal"> 646</span>
<span class="normal"> 647</span>
<span class="normal"> 648</span>
<span class="normal"> 649</span>
<span class="normal"> 650</span>
<span class="normal"> 651</span>
<span class="normal"> 652</span>
<span class="normal"> 653</span>
<span class="normal"> 654</span>
<span class="normal"> 655</span>
<span class="normal"> 656</span>
<span class="normal"> 657</span>
<span class="normal"> 658</span>
<span class="normal"> 659</span>
<span class="normal"> 660</span>
<span class="normal"> 661</span>
<span class="normal"> 662</span>
<span class="normal"> 663</span>
<span class="normal"> 664</span>
<span class="normal"> 665</span>
<span class="normal"> 666</span>
<span class="normal"> 667</span>
<span class="normal"> 668</span>
<span class="normal"> 669</span>
<span class="normal"> 670</span>
<span class="normal"> 671</span>
<span class="normal"> 672</span>
<span class="normal"> 673</span>
<span class="normal"> 674</span>
<span class="normal"> 675</span>
<span class="normal"> 676</span>
<span class="normal"> 677</span>
<span class="normal"> 678</span>
<span class="normal"> 679</span>
<span class="normal"> 680</span>
<span class="normal"> 681</span>
<span class="normal"> 682</span>
<span class="normal"> 683</span>
<span class="normal"> 684</span>
<span class="normal"> 685</span>
<span class="normal"> 686</span>
<span class="normal"> 687</span>
<span class="normal"> 688</span>
<span class="normal"> 689</span>
<span class="normal"> 690</span>
<span class="normal"> 691</span>
<span class="normal"> 692</span>
<span class="normal"> 693</span>
<span class="normal"> 694</span>
<span class="normal"> 695</span>
<span class="normal"> 696</span>
<span class="normal"> 697</span>
<span class="normal"> 698</span>
<span class="normal"> 699</span>
<span class="normal"> 700</span>
<span class="normal"> 701</span>
<span class="normal"> 702</span>
<span class="normal"> 703</span>
<span class="normal"> 704</span>
<span class="normal"> 705</span>
<span class="normal"> 706</span>
<span class="normal"> 707</span>
<span class="normal"> 708</span>
<span class="normal"> 709</span>
<span class="normal"> 710</span>
<span class="normal"> 711</span>
<span class="normal"> 712</span>
<span class="normal"> 713</span>
<span class="normal"> 714</span>
<span class="normal"> 715</span>
<span class="normal"> 716</span>
<span class="normal"> 717</span>
<span class="normal"> 718</span>
<span class="normal"> 719</span>
<span class="normal"> 720</span>
<span class="normal"> 721</span>
<span class="normal"> 722</span>
<span class="normal"> 723</span>
<span class="normal"> 724</span>
<span class="normal"> 725</span>
<span class="normal"> 726</span>
<span class="normal"> 727</span>
<span class="normal"> 728</span>
<span class="normal"> 729</span>
<span class="normal"> 730</span>
<span class="normal"> 731</span>
<span class="normal"> 732</span>
<span class="normal"> 733</span>
<span class="normal"> 734</span>
<span class="normal"> 735</span>
<span class="normal"> 736</span>
<span class="normal"> 737</span>
<span class="normal"> 738</span>
<span class="normal"> 739</span>
<span class="normal"> 740</span>
<span class="normal"> 741</span>
<span class="normal"> 742</span>
<span class="normal"> 743</span>
<span class="normal"> 744</span>
<span class="normal"> 745</span>
<span class="normal"> 746</span>
<span class="normal"> 747</span>
<span class="normal"> 748</span>
<span class="normal"> 749</span>
<span class="normal"> 750</span>
<span class="normal"> 751</span>
<span class="normal"> 752</span>
<span class="normal"> 753</span>
<span class="normal"> 754</span>
<span class="normal"> 755</span>
<span class="normal"> 756</span>
<span class="normal"> 757</span>
<span class="normal"> 758</span>
<span class="normal"> 759</span>
<span class="normal"> 760</span>
<span class="normal"> 761</span>
<span class="normal"> 762</span>
<span class="normal"> 763</span>
<span class="normal"> 764</span>
<span class="normal"> 765</span>
<span class="normal"> 766</span>
<span class="normal"> 767</span>
<span class="normal"> 768</span>
<span class="normal"> 769</span>
<span class="normal"> 770</span>
<span class="normal"> 771</span>
<span class="normal"> 772</span>
<span class="normal"> 773</span>
<span class="normal"> 774</span>
<span class="normal"> 775</span>
<span class="normal"> 776</span>
<span class="normal"> 777</span>
<span class="normal"> 778</span>
<span class="normal"> 779</span>
<span class="normal"> 780</span>
<span class="normal"> 781</span>
<span class="normal"> 782</span>
<span class="normal"> 783</span>
<span class="normal"> 784</span>
<span class="normal"> 785</span>
<span class="normal"> 786</span>
<span class="normal"> 787</span>
<span class="normal"> 788</span>
<span class="normal"> 789</span>
<span class="normal"> 790</span>
<span class="normal"> 791</span>
<span class="normal"> 792</span>
<span class="normal"> 793</span>
<span class="normal"> 794</span>
<span class="normal"> 795</span>
<span class="normal"> 796</span>
<span class="normal"> 797</span>
<span class="normal"> 798</span>
<span class="normal"> 799</span>
<span class="normal"> 800</span>
<span class="normal"> 801</span>
<span class="normal"> 802</span>
<span class="normal"> 803</span>
<span class="normal"> 804</span>
<span class="normal"> 805</span>
<span class="normal"> 806</span>
<span class="normal"> 807</span>
<span class="normal"> 808</span>
<span class="normal"> 809</span>
<span class="normal"> 810</span>
<span class="normal"> 811</span>
<span class="normal"> 812</span>
<span class="normal"> 813</span>
<span class="normal"> 814</span>
<span class="normal"> 815</span>
<span class="normal"> 816</span>
<span class="normal"> 817</span>
<span class="normal"> 818</span>
<span class="normal"> 819</span>
<span class="normal"> 820</span>
<span class="normal"> 821</span>
<span class="normal"> 822</span>
<span class="normal"> 823</span>
<span class="normal"> 824</span>
<span class="normal"> 825</span>
<span class="normal"> 826</span>
<span class="normal"> 827</span>
<span class="normal"> 828</span>
<span class="normal"> 829</span>
<span class="normal"> 830</span>
<span class="normal"> 831</span>
<span class="normal"> 832</span>
<span class="normal"> 833</span>
<span class="normal"> 834</span>
<span class="normal"> 835</span>
<span class="normal"> 836</span>
<span class="normal"> 837</span>
<span class="normal"> 838</span>
<span class="normal"> 839</span>
<span class="normal"> 840</span>
<span class="normal"> 841</span>
<span class="normal"> 842</span>
<span class="normal"> 843</span>
<span class="normal"> 844</span>
<span class="normal"> 845</span>
<span class="normal"> 846</span>
<span class="normal"> 847</span>
<span class="normal"> 848</span>
<span class="normal"> 849</span>
<span class="normal"> 850</span>
<span class="normal"> 851</span>
<span class="normal"> 852</span>
<span class="normal"> 853</span>
<span class="normal"> 854</span>
<span class="normal"> 855</span>
<span class="normal"> 856</span>
<span class="normal"> 857</span>
<span class="normal"> 858</span>
<span class="normal"> 859</span>
<span class="normal"> 860</span>
<span class="normal"> 861</span>
<span class="normal"> 862</span>
<span class="normal"> 863</span>
<span class="normal"> 864</span>
<span class="normal"> 865</span>
<span class="normal"> 866</span>
<span class="normal"> 867</span>
<span class="normal"> 868</span>
<span class="normal"> 869</span>
<span class="normal"> 870</span>
<span class="normal"> 871</span>
<span class="normal"> 872</span>
<span class="normal"> 873</span>
<span class="normal"> 874</span>
<span class="normal"> 875</span>
<span class="normal"> 876</span>
<span class="normal"> 877</span>
<span class="normal"> 878</span>
<span class="normal"> 879</span>
<span class="normal"> 880</span>
<span class="normal"> 881</span>
<span class="normal"> 882</span>
<span class="normal"> 883</span>
<span class="normal"> 884</span>
<span class="normal"> 885</span>
<span class="normal"> 886</span>
<span class="normal"> 887</span>
<span class="normal"> 888</span>
<span class="normal"> 889</span>
<span class="normal"> 890</span>
<span class="normal"> 891</span>
<span class="normal"> 892</span>
<span class="normal"> 893</span>
<span class="normal"> 894</span>
<span class="normal"> 895</span>
<span class="normal"> 896</span>
<span class="normal"> 897</span>
<span class="normal"> 898</span>
<span class="normal"> 899</span>
<span class="normal"> 900</span>
<span class="normal"> 901</span>
<span class="normal"> 902</span>
<span class="normal"> 903</span>
<span class="normal"> 904</span>
<span class="normal"> 905</span>
<span class="normal"> 906</span>
<span class="normal"> 907</span>
<span class="normal"> 908</span>
<span class="normal"> 909</span>
<span class="normal"> 910</span>
<span class="normal"> 911</span>
<span class="normal"> 912</span>
<span class="normal"> 913</span>
<span class="normal"> 914</span>
<span class="normal"> 915</span>
<span class="normal"> 916</span>
<span class="normal"> 917</span>
<span class="normal"> 918</span>
<span class="normal"> 919</span>
<span class="normal"> 920</span>
<span class="normal"> 921</span>
<span class="normal"> 922</span>
<span class="normal"> 923</span>
<span class="normal"> 924</span>
<span class="normal"> 925</span>
<span class="normal"> 926</span>
<span class="normal"> 927</span>
<span class="normal"> 928</span>
<span class="normal"> 929</span>
<span class="normal"> 930</span>
<span class="normal"> 931</span>
<span class="normal"> 932</span>
<span class="normal"> 933</span>
<span class="normal"> 934</span>
<span class="normal"> 935</span>
<span class="normal"> 936</span>
<span class="normal"> 937</span>
<span class="normal"> 938</span>
<span class="normal"> 939</span>
<span class="normal"> 940</span>
<span class="normal"> 941</span>
<span class="normal"> 942</span>
<span class="normal"> 943</span>
<span class="normal"> 944</span>
<span class="normal"> 945</span>
<span class="normal"> 946</span>
<span class="normal"> 947</span>
<span class="normal"> 948</span>
<span class="normal"> 949</span>
<span class="normal"> 950</span>
<span class="normal"> 951</span>
<span class="normal"> 952</span>
<span class="normal"> 953</span>
<span class="normal"> 954</span>
<span class="normal"> 955</span>
<span class="normal"> 956</span>
<span class="normal"> 957</span>
<span class="normal"> 958</span>
<span class="normal"> 959</span>
<span class="normal"> 960</span>
<span class="normal"> 961</span>
<span class="normal"> 962</span>
<span class="normal"> 963</span>
<span class="normal"> 964</span>
<span class="normal"> 965</span>
<span class="normal"> 966</span>
<span class="normal"> 967</span>
<span class="normal"> 968</span>
<span class="normal"> 969</span>
<span class="normal"> 970</span>
<span class="normal"> 971</span>
<span class="normal"> 972</span>
<span class="normal"> 973</span>
<span class="normal"> 974</span>
<span class="normal"> 975</span>
<span class="normal"> 976</span>
<span class="normal"> 977</span>
<span class="normal"> 978</span>
<span class="normal"> 979</span>
<span class="normal"> 980</span>
<span class="normal"> 981</span>
<span class="normal"> 982</span>
<span class="normal"> 983</span>
<span class="normal"> 984</span>
<span class="normal"> 985</span>
<span class="normal"> 986</span>
<span class="normal"> 987</span>
<span class="normal"> 988</span>
<span class="normal"> 989</span>
<span class="normal"> 990</span>
<span class="normal"> 991</span>
<span class="normal"> 992</span>
<span class="normal"> 993</span>
<span class="normal"> 994</span>
<span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span>
<span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span>
<span class="normal">1016</span>
<span class="normal">1017</span>
<span class="normal">1018</span>
<span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span>
<span class="normal">1022</span>
<span class="normal">1023</span>
<span class="normal">1024</span>
<span class="normal">1025</span>
<span class="normal">1026</span>
<span class="normal">1027</span>
<span class="normal">1028</span>
<span class="normal">1029</span>
<span class="normal">1030</span>
<span class="normal">1031</span>
<span class="normal">1032</span>
<span class="normal">1033</span>
<span class="normal">1034</span>
<span class="normal">1035</span>
<span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span>
<span class="normal">1039</span>
<span class="normal">1040</span>
<span class="normal">1041</span>
<span class="normal">1042</span>
<span class="normal">1043</span>
<span class="normal">1044</span>
<span class="normal">1045</span>
<span class="normal">1046</span>
<span class="normal">1047</span>
<span class="normal">1048</span>
<span class="normal">1049</span>
<span class="normal">1050</span>
<span class="normal">1051</span>
<span class="normal">1052</span>
<span class="normal">1053</span>
<span class="normal">1054</span>
<span class="normal">1055</span>
<span class="normal">1056</span>
<span class="normal">1057</span>
<span class="normal">1058</span>
<span class="normal">1059</span>
<span class="normal">1060</span>
<span class="normal">1061</span>
<span class="normal">1062</span>
<span class="normal">1063</span>
<span class="normal">1064</span>
<span class="normal">1065</span>
<span class="normal">1066</span>
<span class="normal">1067</span>
<span class="normal">1068</span>
<span class="normal">1069</span>
<span class="normal">1070</span>
<span class="normal">1071</span>
<span class="normal">1072</span>
<span class="normal">1073</span>
<span class="normal">1074</span>
<span class="normal">1075</span>
<span class="normal">1076</span>
<span class="normal">1077</span>
<span class="normal">1078</span>
<span class="normal">1079</span>
<span class="normal">1080</span>
<span class="normal">1081</span>
<span class="normal">1082</span>
<span class="normal">1083</span>
<span class="normal">1084</span>
<span class="normal">1085</span>
<span class="normal">1086</span>
<span class="normal">1087</span>
<span class="normal">1088</span>
<span class="normal">1089</span>
<span class="normal">1090</span>
<span class="normal">1091</span>
<span class="normal">1092</span>
<span class="normal">1093</span>
<span class="normal">1094</span>
<span class="normal">1095</span>
<span class="normal">1096</span>
<span class="normal">1097</span>
<span class="normal">1098</span>
<span class="normal">1099</span>
<span class="normal">1100</span>
<span class="normal">1101</span>
<span class="normal">1102</span>
<span class="normal">1103</span>
<span class="normal">1104</span>
<span class="normal">1105</span>
<span class="normal">1106</span>
<span class="normal">1107</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">PathwayOptimizer</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Optimizer for housing pathway selection based on multiple criteria.</span>

<span class="sd">    This class provides functionality to optimize pathway selection using Gurobi,</span>
<span class="sd">    allowing for various constraints and objectives to be defined. It supports</span>
<span class="sd">    spatial filtering through boundary polygons and flexible constraint tagging</span>
<span class="sd">    for organization.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        data (gpd.GeoDataFrame): Copy of input GeoDataFrame with pathway data.</span>
<span class="sd">        crs: Coordinate reference system from input GeoDataFrame.</span>
<span class="sd">        pids (list[int]): List of pathway IDs.</span>
<span class="sd">        cost_columns (list[str]): List of cost-related column names.</span>
<span class="sd">        model (gp.Model): Gurobi optimization model (initialized by build_variables).</span>

<span class="sd">    &lt;!--</span>
<span class="sd">    Internal Attributes:</span>
<span class="sd">        _variables (dict[str, gp.Var]): Dictionary mapping variable names to Gurobi variables.</span>
<span class="sd">            (initialized by build_variables).</span>
<span class="sd">        _constraints (dict[str, list[gp.Constr]]): Dictionary mapping tags to lists of constraints.</span>
<span class="sd">        _gindex_to_pid (dict[int, int]): Dictionary mapping gurobi variable indices to pathway IDs.</span>
<span class="sd">        _pid_to_gindex (dict[int, int]): Dictionary mapping pathway ID to gurobi variable indices.</span>
<span class="sd">        _objective_weights (dict[str, float]): Dictionary mapping cost column names to their weights</span>
<span class="sd">            in the objective function.</span>
<span class="sd">        _has_dummies (bool): True if dummy &quot;z&quot; variables have been added to the problem (e.g. via add_conversion_constraints)</span>
<span class="sd">    --&gt;</span>

<span class="sd">    Examples:</span>
<span class="sd">            Basic usage with a GeoDataFrame:</span>

<span class="sd">            ```python</span>
<span class="sd">            import geopandas as gpd</span>
<span class="sd">            from shapely.geometry import Point</span>

<span class="sd">            # Setup dummy data</span>
<span class="sd">            data = {</span>
<span class="sd">                &quot;pid&quot;: [1, 2, 3],</span>
<span class="sd">                &quot;start&quot;: [&quot;A&quot;, &quot;B&quot;, &quot;C&quot;],</span>
<span class="sd">                &quot;end&quot;: [&quot;X&quot;, &quot;Y&quot;, &quot;Z&quot;],</span>
<span class="sd">                &quot;desc&quot;: [&quot;desc1&quot;, &quot;desc2&quot;, &quot;desc3&quot;],</span>
<span class="sd">                &quot;contribution&quot;: [1.0, 2.0, 3.0],</span>
<span class="sd">                &quot;geometry&quot;: [Point(0, 0), Point(1, 1), Point(2, 2)],</span>
<span class="sd">                &quot;cost_emb&quot;: [10, 20, 30],</span>
<span class="sd">                &quot;cost_transit&quot;: [5, 15, 25]</span>
<span class="sd">            }</span>
<span class="sd">            gdf = gpd.GeoDataFrame(data, crs=&quot;EPSG:4326&quot;)</span>

<span class="sd">            # Initialize and run optimizer</span>
<span class="sd">            optimizer = PathwayOptimizer(gdf)</span>
<span class="sd">            optimizer.build_variables()</span>
<span class="sd">            optimizer.set_objective({&quot;cost_emb&quot;: 1.0, &quot;cost_transit&quot;: 0.5})</span>
<span class="sd">            optimizer.add_contribution_constraints(3.0, tag=&quot;constraints&quot;)</span>
<span class="sd">            ```</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gdf</span><span class="p">:</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the PathwayOptimizer.</span>

<span class="sd">        Args:</span>
<span class="sd">            gdf: GeoDataFrame containing pathway data with required columns:</span>
<span class="sd">                - pid: Pathway identifier (integer)</span>
<span class="sd">                - label: Pathway type label (e.g., &quot;adu&quot;)</span>
<span class="sd">                - start: Start point/area</span>
<span class="sd">                - end: End point/area</span>
<span class="sd">                - desc: Description</span>
<span class="sd">                - contribution: Contribution score</span>
<span class="sd">                - geometry: Shapely geometry</span>
<span class="sd">                - cost_*: Cost-related columns</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If any required columns are missing from the GeoDataFrame,</span>
<span class="sd">                       or if any pid values are not integers.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Validate required columns</span>
        <span class="n">required_columns</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;pid&quot;</span><span class="p">,</span>
            <span class="s2">&quot;label&quot;</span><span class="p">,</span>
            <span class="s2">&quot;start&quot;</span><span class="p">,</span>
            <span class="s2">&quot;end&quot;</span><span class="p">,</span>
            <span class="s2">&quot;desc&quot;</span><span class="p">,</span>
            <span class="s2">&quot;contribution&quot;</span><span class="p">,</span>
            <span class="s2">&quot;geometry&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="n">missing_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">required_columns</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">gdf</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">missing_columns</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Missing required columns: </span><span class="si">{</span><span class="n">missing_columns</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># Validate that all PIDs are integers</span>
        <span class="k">if</span> <span class="n">gdf</span><span class="p">[</span><span class="s2">&quot;pid&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="o">!=</span> <span class="s2">&quot;i&quot;</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;All PIDs must be integers&quot;</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># Store a copy of the input data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># Store CRS</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">crs</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">gdf</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>

        <span class="c1"># Store list of pathway IDs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pids</span> <span class="o">=</span> <span class="n">gdf</span><span class="p">[</span><span class="s2">&quot;pid&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="c1"># Extract and store cost columns</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cost_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">gdf</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;cost_&quot;</span><span class="p">)]</span>

        <span class="c1"># Initialize the model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">gp</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="s2">&quot;pathway_optimizer&quot;</span><span class="p">)</span>

        <span class="c1"># Initialize constraint tracking</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_constraints</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Initialize objective function</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_objective_weights</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_has_dummies</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">load</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;PathwayOptimizer&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load an optimizer from saved files.</span>

<span class="sd">        Args:</span>
<span class="sd">            path: Base path for loading files (without extension).</span>
<span class="sd">                 Will look for {path}.geoparquet and {path}.json.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A new PathwayOptimizer instance with restored state.</span>

<span class="sd">        Raises:</span>
<span class="sd">            FileNotFoundError: If either file is missing.</span>
<span class="sd">            ValueError: If saved state is invalid.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

        <span class="c1"># Load GeoDataFrame first</span>
        <span class="n">parquet_path</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;.geoparquet&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">parquet_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;GeoParquet file not found: </span><span class="si">{</span><span class="n">parquet_path</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="n">parquet_path</span><span class="p">)</span>

        <span class="c1"># Load and validate config</span>
        <span class="n">json_path</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;.json&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">json_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;JSON configuration file not found: </span><span class="si">{</span><span class="n">json_path</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">config_dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">json_path</span><span class="o">.</span><span class="n">read_text</span><span class="p">())</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">OptimizerConfigSchema</span><span class="o">.</span><span class="n">model_validate</span><span class="p">(</span><span class="n">config_dict</span><span class="p">)</span>

        <span class="c1"># Build model</span>
        <span class="n">optimizer</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">optimizer</span><span class="o">.</span><span class="n">build_variables</span><span class="p">()</span>

        <span class="c1"># Restore objective if present</span>
        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">objective</span><span class="p">:</span>
            <span class="n">optimizer</span><span class="o">.</span><span class="n">set_objective</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">objective</span><span class="p">)</span>

        <span class="c1"># Deserialize and restore constraints</span>
        <span class="k">for</span> <span class="n">tag</span><span class="p">,</span> <span class="n">constr_list</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">constraints</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">constr</span> <span class="ow">in</span> <span class="n">constr_list</span><span class="p">:</span>
                <span class="n">optimizer</span><span class="o">.</span><span class="n">_deserialize_and_register_constraint</span><span class="p">(</span><span class="n">constr</span><span class="o">=</span><span class="n">constr</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="n">tag</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">optimizer</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">build_variables</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create binary variables for each pathway and initialize the Gurobi model.</span>

<span class="sd">        Creates one binary variable per pathway ID and stores them in self._variables.</span>
<span class="sd">        Also creates and stores the Gurobi model in self.model.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Initialize variable tracking</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_variables</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">gp</span><span class="o">.</span><span class="n">Var</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Initialize index mapping dictionaries</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_gindex_to_pid</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pid_to_gindex</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Create binary variables for each pathway</span>
        <span class="k">for</span> <span class="n">pid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pids</span><span class="p">:</span>
            <span class="n">var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">addVar</span><span class="p">(</span><span class="n">vtype</span><span class="o">=</span><span class="n">gp</span><span class="o">.</span><span class="n">GRB</span><span class="o">.</span><span class="n">BINARY</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;x_</span><span class="si">{</span><span class="n">pid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_variables</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;x_</span><span class="si">{</span><span class="n">pid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">var</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_gindex_to_pid</span><span class="p">[</span><span class="n">var</span><span class="o">.</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">pid</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pid_to_gindex</span><span class="p">[</span><span class="n">pid</span><span class="p">]</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">index</span>

        <span class="c1"># Update the model to include the new variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">set_objective</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weights</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the optimization objective using weighted costs.</span>

<span class="sd">        Args:</span>
<span class="sd">            weights: Dictionary mapping cost column names to their weights.</span>
<span class="sd">                    Keys must exist in self.cost_columns.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If any weight key is not a valid cost column.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Validate weights</span>
        <span class="n">invalid_weights</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">weights</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cost_columns</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">invalid_weights</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Invalid cost columns in weights: </span><span class="si">{</span><span class="n">invalid_weights</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Available cost columns: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cost_columns</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># Store weights internally</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_objective_weights</span> <span class="o">=</span> <span class="n">weights</span>

        <span class="c1"># Create a dictionary to look up costs faster</span>
        <span class="n">cost_matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;pid&quot;</span><span class="p">)[</span><span class="nb">list</span><span class="p">(</span><span class="n">weights</span><span class="o">.</span><span class="n">keys</span><span class="p">())]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span>
            <span class="n">orient</span><span class="o">=</span><span class="s2">&quot;index&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Precomputing weights per pid saves having to</span>
        <span class="c1"># construct a huge gurobi linear expression</span>
        <span class="n">varnames</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;x_</span><span class="si">{</span><span class="n">pid</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">pid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pids</span><span class="p">]</span>
        <span class="n">weighted_cost</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sa">f</span><span class="s2">&quot;x_</span><span class="si">{</span><span class="n">pid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">*</span> <span class="n">cost_matrix</span><span class="p">[</span><span class="n">pid</span><span class="p">][</span><span class="n">col</span><span class="p">]</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">weights</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">pid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pids</span>
        <span class="p">}</span>

        <span class="n">objective</span> <span class="o">=</span> <span class="n">gp</span><span class="o">.</span><span class="n">quicksum</span><span class="p">(</span>
            <span class="n">weighted_cost</span><span class="p">[</span><span class="n">vn</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_variables</span><span class="p">[</span><span class="n">vn</span><span class="p">]</span> <span class="k">for</span> <span class="n">vn</span> <span class="ow">in</span> <span class="n">varnames</span>
        <span class="p">)</span>

        <span class="c1"># Set as minimization objective</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">setObjective</span><span class="p">(</span><span class="n">objective</span><span class="p">,</span> <span class="n">gp</span><span class="o">.</span><span class="n">GRB</span><span class="o">.</span><span class="n">MINIMIZE</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_selected_pids</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the list of selected pathway IDs from the solved model.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A list of pathway IDs that were selected (variable value = 1)</span>

<span class="sd">        Raises:</span>
<span class="sd">            RuntimeError: If the model has not been solved yet.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">SolCount</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Model has not been solved yet&quot;</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

        <span class="k">return</span> <span class="p">[</span>
            <span class="n">pid</span>
            <span class="k">for</span> <span class="n">pid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pids</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_variables</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;x_</span><span class="si">{</span><span class="n">pid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">X</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span>
            <span class="o">&lt;</span> <span class="mf">1e-6</span>  <span class="c1"># Check if binary variable is 1</span>
        <span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_solution_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get a summary of the optimization results.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: Dictionary containing the results with the following keys:</span>

<span class="sd">                * **objective_value** (float): The final objective value.</span>
<span class="sd">                * **total_contribution** (float): Sum of contribution for selected pathways.</span>
<span class="sd">                * **solve_time** (float): Time taken to solve the model (seconds).</span>
<span class="sd">                * **selected_count** (int): Number of selected pathways.</span>

<span class="sd">        Raises:</span>
<span class="sd">            RuntimeError: If the model has not been solved yet.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">SolCount</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Model has not been solved yet&quot;</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">selected_pids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_selected_pids</span><span class="p">()</span>
        <span class="n">filtered</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;pid&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">selected_pids</span><span class="p">)]</span>

        <span class="n">total_contribution</span> <span class="o">=</span> <span class="n">filtered</span><span class="p">[</span><span class="s2">&quot;contribution&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="n">costs</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="p">:</span> <span class="n">filtered</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cost_columns</span><span class="p">}</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;objective_value&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">ObjVal</span><span class="p">,</span>
            <span class="s2">&quot;cost_column_sums&quot;</span><span class="p">:</span> <span class="n">costs</span><span class="p">,</span>
            <span class="s2">&quot;total_contribution&quot;</span><span class="p">:</span> <span class="n">total_contribution</span><span class="p">,</span>
            <span class="s2">&quot;solve_time&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">Runtime</span><span class="p">,</span>
            <span class="s2">&quot;selected_count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">selected_pids</span><span class="p">),</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">print_solution_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Pretty-print a summary of the optimization results.</span>

<span class="sd">        Prints a formatted summary including:</span>
<span class="sd">        - Objective value</span>
<span class="sd">        - Total contribution of selected pathways</span>
<span class="sd">        - Solve time in seconds</span>
<span class="sd">        - Number of selected pathways</span>

<span class="sd">        Raises:</span>
<span class="sd">            RuntimeError: If the model has not been solved yet.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">summary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_solution_summary</span><span class="p">()</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Optimization Summary&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Objective Value   : </span><span class="si">{</span><span class="n">summary</span><span class="p">[</span><span class="s1">&#39;objective_value&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Total Contribution: </span><span class="si">{</span><span class="n">summary</span><span class="p">[</span><span class="s1">&#39;total_contribution&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Solve Time        : </span><span class="si">{</span><span class="n">summary</span><span class="p">[</span><span class="s1">&#39;solve_time&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> sec&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Selected Pathways : </span><span class="si">{</span><span class="n">summary</span><span class="p">[</span><span class="s1">&#39;selected_count&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_contribution_constraints</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">limits</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
        <span class="n">sense</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">boundaries</span><span class="p">:</span> <span class="kc">None</span> <span class="o">|</span> <span class="n">Polygon</span> <span class="o">|</span> <span class="n">MultiPolygon</span> <span class="o">|</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">tag</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">gp</span><span class="o">.</span><span class="n">MConstr</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a constraint limiting the total contribution within a given boundary (or boundaries).</span>

<span class="sd">        Always returns a matrix constraint.</span>

<span class="sd">        Args:</span>
<span class="sd">            limits (float | list[float]): Maximum allowed total contribution (or a list of those).</span>
<span class="sd">            sense (str): One of &quot;&lt;=&quot;, &quot;&gt;=&quot;, or &quot;==&quot;</span>
<span class="sd">            boundaries (None | Polygon | MultiPolygon | list, optional): Optional boundary or list of boundaries.</span>
<span class="sd">            tag (str | None, optional): Optional tag for constraint tracking or removal.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A Gurobi matrix constraint object</span>

<span class="sd">        Raises:</span>
<span class="sd">            TypeError: If boundaries are not valid geometry types.</span>
<span class="sd">            ValueError: If number of limits and boundaries do not match.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Coerce inputs to lists</span>
        <span class="k">if</span> <span class="n">boundaries</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">boundaries</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">limits</span><span class="p">,</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">)):</span>
            <span class="n">limits</span> <span class="o">=</span> <span class="p">[</span><span class="n">limits</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">boundaries</span><span class="p">,</span> <span class="p">(</span><span class="n">Polygon</span><span class="p">,</span> <span class="n">MultiPolygon</span><span class="p">)):</span>
            <span class="n">boundaries</span> <span class="o">=</span> <span class="p">[</span><span class="n">boundaries</span><span class="p">]</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">boundaries</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Unsupported boundaries type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">boundaries</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">limits</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">boundaries</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Number of limits must match number of boundaries.&quot;</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">boundaries</span> <span class="o">==</span> <span class="p">[</span><span class="kc">None</span><span class="p">]:</span>
            <span class="c1"># Case 1: No boundary specified: use all pathways</span>
            <span class="n">filtered_pids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pids</span>
            <span class="n">pid_to_group</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">filtered_pids</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># All go into group 0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Case 2: Boundaries specified  spatial join</span>

            <span class="n">boundary_gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span>
                <span class="p">{</span><span class="s2">&quot;limit&quot;</span><span class="p">:</span> <span class="n">limits</span><span class="p">},</span>
                <span class="n">geometry</span><span class="o">=</span><span class="n">boundaries</span><span class="p">,</span>
                <span class="n">crs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">boundary_gdf</span><span class="p">[</span><span class="s2">&quot;group_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">boundary_gdf</span><span class="o">.</span><span class="n">index</span>
            <span class="n">joined</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">sjoin</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[[</span><span class="s2">&quot;pid&quot;</span><span class="p">,</span> <span class="s2">&quot;contribution&quot;</span><span class="p">,</span> <span class="s2">&quot;geometry&quot;</span><span class="p">]],</span>
                <span class="n">boundary_gdf</span><span class="p">[[</span><span class="s2">&quot;group_id&quot;</span><span class="p">,</span> <span class="s2">&quot;geometry&quot;</span><span class="p">]],</span>
                <span class="n">how</span><span class="o">=</span><span class="s2">&quot;inner&quot;</span><span class="p">,</span>
                <span class="n">predicate</span><span class="o">=</span><span class="s2">&quot;intersects&quot;</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">joined</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;No pathways intersect the given boundaries.&quot;</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="n">filtered_pids</span> <span class="o">=</span> <span class="n">joined</span><span class="p">[</span><span class="s2">&quot;pid&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
            <span class="n">pid_to_group</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="nb">zip</span><span class="p">(</span><span class="n">joined</span><span class="p">[</span><span class="s2">&quot;pid&quot;</span><span class="p">],</span> <span class="n">joined</span><span class="p">[</span><span class="s2">&quot;group_id&quot;</span><span class="p">],</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
            <span class="p">)</span>

        <span class="c1"># Build mapping and sparse matrix</span>
        <span class="n">pid_to_index</span> <span class="o">=</span> <span class="p">{</span><span class="n">pid</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">pid</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">filtered_pids</span><span class="p">)}</span>
        <span class="n">contribution_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;pid&quot;</span><span class="p">)[</span><span class="s2">&quot;contribution&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

        <span class="n">row_indices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">col_indices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">pid</span> <span class="ow">in</span> <span class="n">filtered_pids</span><span class="p">:</span>
            <span class="n">col_idx</span> <span class="o">=</span> <span class="n">pid_to_index</span><span class="p">[</span><span class="n">pid</span><span class="p">]</span>
            <span class="n">group_idx</span> <span class="o">=</span> <span class="n">pid_to_group</span><span class="p">[</span><span class="n">pid</span><span class="p">]</span>

            <span class="n">row_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">group_idx</span><span class="p">)</span>
            <span class="n">col_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col_idx</span><span class="p">)</span>
            <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">contribution_map</span><span class="p">[</span><span class="n">pid</span><span class="p">])</span>

        <span class="n">coeffs</span> <span class="o">=</span> <span class="n">coo_matrix</span><span class="p">(</span>
            <span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="n">row_indices</span><span class="p">,</span> <span class="n">col_indices</span><span class="p">)),</span>
            <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">limits</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">filtered_pids</span><span class="p">)),</span>
        <span class="p">)</span><span class="o">.</span><span class="n">tocsr</span><span class="p">()</span>

        <span class="n">rhs_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">limits</span><span class="p">)</span>

        <span class="n">varnames</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;x_</span><span class="si">{</span><span class="n">pid</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">pid</span> <span class="ow">in</span> <span class="n">filtered_pids</span><span class="p">]</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_register_matrix_constraint</span><span class="p">(</span>
            <span class="n">varnames</span><span class="o">=</span><span class="n">varnames</span><span class="p">,</span>
            <span class="n">coeffs</span><span class="o">=</span><span class="n">coeffs</span><span class="p">,</span>
            <span class="n">sense</span><span class="o">=</span><span class="n">sense</span><span class="p">,</span>
            <span class="n">rhs</span><span class="o">=</span><span class="n">rhs_array</span><span class="p">,</span>
            <span class="n">tag</span><span class="o">=</span><span class="n">tag</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_zone_difference_constraints</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">geom_pairs</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">Polygon</span> <span class="o">|</span> <span class="n">MultiPolygon</span><span class="p">,</span> <span class="n">Polygon</span> <span class="o">|</span> <span class="n">MultiPolygon</span><span class="p">]],</span>
        <span class="n">sense</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">limits</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
        <span class="n">tag</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">gp</span><span class="o">.</span><span class="n">MConstr</span><span class="p">,</span> <span class="n">gp</span><span class="o">.</span><span class="n">MConstr</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Constrain the (absolute) difference in contribution within two geometries within a given limit.</span>

<span class="sd">        For each pair of geometries (zone1, zone2), enforces:</span>
<span class="sd">            sum(contribution in zone1) - sum(contribution in zone2) &lt;= limit</span>
<span class="sd">            sum(contribution in zone2) - sum(contribution in zone1) &lt;= limit</span>

<span class="sd">        Args:</span>
<span class="sd">            geom_pairs: List of (geom1, geom2) tuples.</span>
<span class="sd">            sense (str): One of &quot;&lt;=&quot;, &quot;&gt;=&quot;, or &quot;==&quot;</span>
<span class="sd">            limits (float | list[float]): Maximum allowed total contribution (or a list of those).</span>
<span class="sd">            tag (str | None, optional): Optional tag for constraint tracking or removal.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Two Gurobi matrix constraint objects for the absolute difference.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If geom_pairs and limits are not the same length.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Create GeoDataFrame</span>
        <span class="n">geoms1</span><span class="p">,</span> <span class="n">geoms2</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">geom_pairs</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">geom_pairs</span><span class="p">)))</span>

        <span class="n">gdf1</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span>
            <span class="p">{</span><span class="s2">&quot;row&quot;</span><span class="p">:</span> <span class="n">indices</span><span class="p">,</span> <span class="s2">&quot;side&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="n">geoms1</span><span class="p">},</span>
            <span class="n">crs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">gdf2</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span>
            <span class="p">{</span><span class="s2">&quot;row&quot;</span><span class="p">:</span> <span class="n">indices</span><span class="p">,</span> <span class="s2">&quot;side&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="n">geoms2</span><span class="p">},</span>
            <span class="n">crs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">combined</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span>
            <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">gdf1</span><span class="p">,</span> <span class="n">gdf2</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
            <span class="n">crs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># Join with data</span>
        <span class="n">pid_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[[</span><span class="s2">&quot;pid&quot;</span><span class="p">,</span> <span class="s2">&quot;contribution&quot;</span><span class="p">,</span> <span class="s2">&quot;geometry&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">combined</span> <span class="o">=</span> <span class="n">combined</span><span class="o">.</span><span class="n">sjoin</span><span class="p">(</span><span class="n">pid_data</span><span class="p">,</span> <span class="n">predicate</span><span class="o">=</span><span class="s2">&quot;intersects&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
        <span class="n">combined</span> <span class="o">=</span> <span class="n">combined</span><span class="p">[</span><span class="o">~</span><span class="n">combined</span><span class="p">[</span><span class="s2">&quot;contribution&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()]</span>
        <span class="n">combined</span><span class="p">[</span><span class="s2">&quot;pid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">combined</span><span class="p">[</span><span class="s2">&quot;pid&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">combined</span><span class="p">[</span><span class="s2">&quot;index_right&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">combined</span><span class="p">[</span><span class="s2">&quot;index_right&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="c1"># Duplicates occur when a pathway is right on a border. We will just drop them</span>
        <span class="c1"># and pretend like they contribute equally to both</span>
        <span class="c1"># HACK</span>
        <span class="n">dupes</span> <span class="o">=</span> <span class="n">combined</span><span class="o">.</span><span class="n">duplicated</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;row&quot;</span><span class="p">,</span> <span class="s2">&quot;pid&quot;</span><span class="p">],</span> <span class="n">keep</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">combined</span> <span class="o">=</span> <span class="n">combined</span><span class="p">[</span><span class="o">~</span><span class="n">dupes</span><span class="p">]</span>

        <span class="c1"># Create maps</span>
        <span class="n">pid_set</span> <span class="o">=</span> <span class="n">combined</span><span class="p">[</span><span class="s2">&quot;pid&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">()</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">pid_to_index</span> <span class="o">=</span> <span class="p">{</span><span class="n">p</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pid_set</span><span class="p">)}</span>
        <span class="n">varnames</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;x_</span><span class="si">{</span><span class="n">pid</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">pid</span> <span class="ow">in</span> <span class="n">pid_set</span><span class="p">]</span>

        <span class="c1"># Construct COO matrix</span>
        <span class="n">row_indices</span> <span class="o">=</span> <span class="n">combined</span><span class="p">[</span><span class="s2">&quot;row&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
        <span class="n">col_indices</span> <span class="o">=</span> <span class="n">combined</span><span class="p">[</span><span class="s2">&quot;pid&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">pid_to_index</span><span class="p">)</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
        <span class="n">combined</span><span class="p">[</span><span class="s2">&quot;coeff&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">combined</span><span class="p">[</span><span class="s2">&quot;contribution&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">combined</span><span class="p">[</span><span class="s2">&quot;side&quot;</span><span class="p">]</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">combined</span><span class="p">[</span><span class="s2">&quot;coeff&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>

        <span class="n">coeffs</span> <span class="o">=</span> <span class="n">coo_matrix</span><span class="p">(</span>
            <span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="p">(</span><span class="n">row_indices</span><span class="p">,</span> <span class="n">col_indices</span><span class="p">)),</span>
            <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">limits</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">pid_set</span><span class="p">)),</span>
        <span class="p">)</span><span class="o">.</span><span class="n">tocsr</span><span class="p">()</span>

        <span class="n">rhs_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">limits</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

        <span class="c1"># Add both sides of absolute value constraint</span>
        <span class="n">constrs1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_register_matrix_constraint</span><span class="p">(</span>
            <span class="n">varnames</span><span class="o">=</span><span class="n">varnames</span><span class="p">,</span>
            <span class="n">coeffs</span><span class="o">=</span><span class="n">coeffs</span><span class="p">,</span>
            <span class="n">sense</span><span class="o">=</span><span class="n">sense</span><span class="p">,</span>
            <span class="n">rhs</span><span class="o">=</span><span class="n">rhs_array</span><span class="p">,</span>
            <span class="n">tag</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s2">_1&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">constrs2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_register_matrix_constraint</span><span class="p">(</span>
            <span class="n">varnames</span><span class="o">=</span><span class="n">varnames</span><span class="p">,</span>
            <span class="n">coeffs</span><span class="o">=-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">coeffs</span><span class="p">,</span>
            <span class="n">sense</span><span class="o">=</span><span class="n">sense</span><span class="p">,</span>
            <span class="n">rhs</span><span class="o">=</span><span class="n">rhs_array</span><span class="p">,</span>
            <span class="n">tag</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s2">_2&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">constrs1</span><span class="p">,</span> <span class="n">constrs2</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_conversion_constraints</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">start_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">sense</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">check_overlaps</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">proj_crs</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">debuff</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">tag</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">gp</span><span class="o">.</span><span class="n">Constr</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Constrain the sum of pathways that start from a given &quot;start&quot; type.</span>

<span class="sd">        This method can be used to (e.g.) constrain the total number of pathways that start</span>
<span class="sd">        from &quot;sfh&quot; to 10, indicating that only 10 sfh can be converted.</span>

<span class="sd">        If check_overlaps is True, the method attempts to count overlapping pathways</span>
<span class="sd">        (potentially after a &#39;debuff&#39;) as a single unit in the sum. Otherwise,</span>
<span class="sd">        it simply constrains the sum of individual selected pathways.</span>

<span class="sd">        The constraint is of the form:</span>
<span class="sd">            sum(effective_pathways) [sense] limit</span>

<span class="sd">        Where &#39;effective_pathways&#39; are individual pathways (x_pid) or</span>
<span class="sd">        indicator variables (z_group) if check_overlaps is True.</span>

<span class="sd">        Args:</span>
<span class="sd">            start_name (str): String from self.data[&quot;start] to filter on.</span>
<span class="sd">            sense (str): One of &quot;&lt;=&quot;, &quot;&gt;=&quot;, or &quot;==&quot; for the constraint.</span>
<span class="sd">            limit (int): The right-hand side value for the constraint.</span>
<span class="sd">            check_overlaps (bool, optional): If True, attempts to identify and group</span>
<span class="sd">                overlapping pathways. Defaults to False.</span>
<span class="sd">            proj_crs (str | None, optional): A projected CRS to use for geometric</span>
<span class="sd">                operations (buffer, overlap). Required if self.data CRS is geographic.</span>
<span class="sd">                Defaults to None.</span>
<span class="sd">            debuff (float, optional): A distance to shrink pathway geometries by before checking overlaps.</span>
<span class="sd">                Requires check_overlaps=True. Value must be non-negative. Defaults to 0.</span>
<span class="sd">            tag (str | None, optional): Optional tag for constraint tracking or removal. Defaults to None.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The Gurobi constraint object added to the model.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If debuff is negative.</span>
<span class="sd">            ValueError: If no pathways start from start_name.</span>
<span class="sd">            ValueError: If data CRS is geographic and proj_crs is not provided.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Checking arguments</span>
        <span class="k">if</span> <span class="n">debuff</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Value for parameter debuff must be &gt;= 0.&quot;</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">debuff</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">check_overlaps</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Specifying debuff without setting check_overlaps=True will not do anything&quot;</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">filtered</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">start_name</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">filtered</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;No pathways start from </span><span class="si">{</span><span class="n">start_name</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">proj_crs</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">check_overlaps</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Specifying proj_crs without setting check_overlaps=True will not do anything&quot;</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">proj_crs</span><span class="p">:</span>
            <span class="n">filtered</span> <span class="o">=</span> <span class="n">filtered</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">proj_crs</span><span class="p">)</span>

        <span class="c1"># Get relevant pids</span>
        <span class="k">if</span> <span class="n">check_overlaps</span><span class="p">:</span>
            <span class="n">filtered</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">filtered</span><span class="o">.</span><span class="n">buffer</span><span class="p">(</span><span class="o">-</span><span class="n">debuff</span><span class="p">)</span>

            <span class="n">grph</span> <span class="o">=</span> <span class="n">PolyGraph</span><span class="o">.</span><span class="n">from_geoseries</span><span class="p">(</span>
                <span class="n">filtered</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;pid&quot;</span><span class="p">)[</span><span class="s2">&quot;geometry&quot;</span><span class="p">],</span>  <span class="c1"># type: ignore[arg-type]</span>
                <span class="n">predicate</span><span class="o">=</span><span class="s2">&quot;intersects&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">id_to_cc</span><span class="p">,</span> <span class="n">cc_to_ids</span> <span class="o">=</span> <span class="n">grph</span><span class="o">.</span><span class="n">get_connected_components_map</span><span class="p">()</span>

            <span class="c1"># every pid should be mapped to the set of its connected components</span>
            <span class="n">pids</span> <span class="o">=</span> <span class="p">{</span><span class="n">p</span><span class="p">:</span> <span class="n">cc_to_ids</span><span class="p">[</span><span class="n">id_to_cc</span><span class="p">[</span><span class="n">p</span><span class="p">]]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">filtered</span><span class="p">[</span><span class="s2">&quot;pid&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pids</span> <span class="o">=</span> <span class="p">{</span><span class="n">p</span><span class="p">:</span> <span class="p">{</span><span class="n">p</span><span class="p">}</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">filtered</span><span class="p">[</span><span class="s2">&quot;pid&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())}</span>

        <span class="n">var_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">visited</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">pid</span><span class="p">,</span> <span class="n">overlap_set</span> <span class="ow">in</span> <span class="n">pids</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># If the pathway doesn&#39;t overlap with anything, just add it by itself</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">overlap_set</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">var_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;x_</span><span class="si">{</span><span class="n">pid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Otherwise we add an auxillary variable</span>
            <span class="k">elif</span> <span class="n">overlap_set</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">visited</span><span class="p">:</span>
                <span class="n">suffix</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">overlap_set</span><span class="p">))</span>
                <span class="n">dummy_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;z_</span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">addVar</span><span class="p">(</span><span class="n">vtype</span><span class="o">=</span><span class="n">gp</span><span class="o">.</span><span class="n">GRB</span><span class="o">.</span><span class="n">BINARY</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">dummy_name</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_variables</span><span class="p">[</span><span class="n">dummy_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">z</span>

                <span class="n">constr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">addGenConstrOr</span><span class="p">(</span>
                    <span class="n">z</span><span class="p">,</span>
                    <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_variables</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;x_</span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">overlap_set</span><span class="p">],</span>
                <span class="p">)</span>

                <span class="n">dummy_tag</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s2">_dummy&quot;</span> <span class="k">if</span> <span class="n">tag</span> <span class="k">else</span> <span class="s2">&quot;dummy&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_constraints</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">dummy_tag</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">constr</span><span class="p">)</span>

                <span class="n">var_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dummy_name</span><span class="p">)</span>
                <span class="n">visited</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">frozenset</span><span class="p">(</span><span class="n">overlap_set</span><span class="p">))</span>

        <span class="n">coeff_map</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">var_list</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_register_constraint</span><span class="p">(</span>
            <span class="n">varnames</span><span class="o">=</span><span class="n">var_list</span><span class="p">,</span>
            <span class="n">coeff_map</span><span class="o">=</span><span class="n">coeff_map</span><span class="p">,</span>
            <span class="n">sense</span><span class="o">=</span><span class="n">sense</span><span class="p">,</span>
            <span class="n">rhs</span><span class="o">=</span><span class="n">limit</span><span class="p">,</span>
            <span class="n">tag</span><span class="o">=</span><span class="n">tag</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_mutual_exclusion</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">label1</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">label2</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">tag</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">gp</span><span class="o">.</span><span class="n">MConstr</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add mutual exclusion constraints between pathways based on their labels.</span>

<span class="sd">        If label2 is provided, creates constraints ensuring no pathway with label1 can be selected with an intersecting pathway with label2.</span>
<span class="sd">        If label2 is not provided, creates constraints ensuring no pathway with label1 can be selected with ANY intersecting pathway (regardless of label).</span>

<span class="sd">        Uses GeoPandas spatial join for efficient intersection detection.</span>

<span class="sd">        Args:</span>
<span class="sd">            label1: First pathway label to find mutual exclusions for.</span>
<span class="sd">            label2 (Optional, None): Pathways with which label1 cannot co-occur. Defaults to None (all pathways)</span>
<span class="sd">            tag: Optional tag for constraint tracking/removal.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Gurobi matrix constraint object, or None if no overlaps are found</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">label1_paths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">label1</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">label1_paths</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">label2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># i.e., Exclusive with all</span>
            <span class="n">other_paths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">label1</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">other_paths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">label2</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">other_paths</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Perform spatial join: find intersecting geometry pairs</span>
        <span class="n">joined</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">sjoin</span><span class="p">(</span>
            <span class="n">other_paths</span><span class="p">,</span>
            <span class="n">label1_paths</span><span class="p">,</span>
            <span class="n">how</span><span class="o">=</span><span class="s2">&quot;inner&quot;</span><span class="p">,</span>
            <span class="n">predicate</span><span class="o">=</span><span class="s2">&quot;intersects&quot;</span><span class="p">,</span>
            <span class="n">lsuffix</span><span class="o">=</span><span class="s2">&quot;other&quot;</span><span class="p">,</span>
            <span class="n">rsuffix</span><span class="o">=</span><span class="s2">&quot;label1&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Construct variables</span>
        <span class="n">pids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">joined</span><span class="p">[</span><span class="s2">&quot;pid_label1&quot;</span><span class="p">])</span> <span class="o">|</span> <span class="nb">set</span><span class="p">(</span><span class="n">joined</span><span class="p">[</span><span class="s2">&quot;pid_other&quot;</span><span class="p">]))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pids</span><span class="p">:</span>  <span class="c1"># No intersecting pathways found</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">index_map</span> <span class="o">=</span> <span class="p">{</span><span class="n">pid</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">pid</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pids</span><span class="p">)}</span>

        <span class="c1"># Construct coefficient matrix</span>
        <span class="n">seen_pairs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">rhs_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">joined</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">pid1</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;pid_label1&quot;</span><span class="p">]</span>
            <span class="n">pid2</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;pid_other&quot;</span><span class="p">]</span>

            <span class="n">key</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">((</span><span class="n">pid1</span><span class="p">,</span> <span class="n">pid2</span><span class="p">)))</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">seen_pairs</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">seen_pairs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

            <span class="c1"># Add coefficients for this constraint</span>
            <span class="n">rows</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">rhs_list</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">rhs_list</span><span class="p">)])</span>
            <span class="n">cols</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">index_map</span><span class="p">[</span><span class="n">pid1</span><span class="p">],</span> <span class="n">index_map</span><span class="p">[</span><span class="n">pid2</span><span class="p">]])</span>
            <span class="n">data</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">])</span>  <span class="c1"># Coefficients are 1.0 for both variables</span>
            <span class="n">rhs_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>

        <span class="c1"># Create sparse matrix</span>
        <span class="n">coeffs</span> <span class="o">=</span> <span class="n">coo_matrix</span><span class="p">(</span>
            <span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">)),</span>
            <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rhs_list</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">pids</span><span class="p">)),</span>
        <span class="p">)</span><span class="o">.</span><span class="n">tocsr</span><span class="p">()</span>

        <span class="c1"># Construct the rhs</span>
        <span class="n">rhs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rhs_list</span><span class="p">)</span>

        <span class="c1"># Convert to variable names</span>
        <span class="n">varnames</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;x_</span><span class="si">{</span><span class="n">pid</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">pid</span> <span class="ow">in</span> <span class="n">pids</span><span class="p">]</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_register_matrix_constraint</span><span class="p">(</span>
            <span class="n">varnames</span><span class="o">=</span><span class="n">varnames</span><span class="p">,</span>
            <span class="n">coeffs</span><span class="o">=</span><span class="n">coeffs</span><span class="p">,</span>
            <span class="n">rhs</span><span class="o">=</span><span class="n">rhs</span><span class="p">,</span>
            <span class="n">sense</span><span class="o">=</span><span class="s2">&quot;&lt;=&quot;</span><span class="p">,</span>
            <span class="n">tag</span><span class="o">=</span><span class="n">tag</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_max_contribution_near_point</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">limit</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">point</span><span class="p">:</span> <span class="n">Point</span><span class="p">,</span>
        <span class="n">distance</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">proj_crs</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">tag</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">gp</span><span class="o">.</span><span class="n">Constr</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a constraint limiting total contribution for pathways near a point.</span>

<span class="sd">        Args:</span>
<span class="sd">            limit: Maximum allowed total contribution across selected pathways.</span>
<span class="sd">            point: Shapely Point to measure distance from.</span>
<span class="sd">            distance: Maximum distance from point to pathway centroid.</span>
<span class="sd">            proj_crs: Optional CRS to project geometries into before distance calculation.</span>
<span class="sd">                 If not provided, uses the current CRS which must be projected.</span>
<span class="sd">            tag: Optional tag for constraint tracking/removal.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The created Gurobi constraint object.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If no CRS is provided and current CRS is not projected.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># If CRS provided, project data and point</span>
        <span class="k">if</span> <span class="n">proj_crs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">proj_crs</span><span class="p">)</span>
            <span class="n">point</span> <span class="o">=</span> <span class="n">_reproject_point</span><span class="p">(</span><span class="n">point</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span> <span class="n">proj_crs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">crs</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">crs</span><span class="o">.</span><span class="n">is_geographic</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Must provide projected CRS for distance calculation&quot;</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span>

        <span class="c1"># Filter pathways by distance from point to centroid</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">centroid</span><span class="o">.</span><span class="n">distance</span><span class="p">(</span><span class="n">point</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">distance</span>
        <span class="n">filtered_pids</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">mask</span><span class="p">][</span><span class="s2">&quot;pid&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="n">coeff_map</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sa">f</span><span class="s2">&quot;x_</span><span class="si">{</span><span class="n">pid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;pid&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">pid</span><span class="p">][</span><span class="s2">&quot;contribution&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">pid</span> <span class="ow">in</span> <span class="n">filtered_pids</span>
        <span class="p">}</span>
        <span class="n">varnames</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">coeff_map</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_register_constraint</span><span class="p">(</span>
            <span class="n">varnames</span><span class="o">=</span><span class="n">varnames</span><span class="p">,</span>
            <span class="n">coeff_map</span><span class="o">=</span><span class="n">coeff_map</span><span class="p">,</span>
            <span class="n">sense</span><span class="o">=</span><span class="s2">&quot;&lt;=&quot;</span><span class="p">,</span>
            <span class="n">rhs</span><span class="o">=</span><span class="n">limit</span><span class="p">,</span>
            <span class="n">tag</span><span class="o">=</span><span class="n">tag</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">remove_constraints</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Remove all constraints associated with a given tag.</span>

<span class="sd">        Args:</span>
<span class="sd">            tag: The tag identifying which constraints to remove.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If the tag does not exist.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">tag</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_constraints</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Tag &#39;</span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s2">&#39; not found in constraints&quot;</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># Remove constraints from model</span>
        <span class="k">for</span> <span class="n">constr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_constraints</span><span class="p">[</span><span class="n">tag</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">constr</span><span class="p">)</span>

        <span class="c1"># Remove constraints from tracking dictionary</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_constraints</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span>

        <span class="c1"># Update model to reflect changes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">solve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">logfile</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Solve the optimization model.</span>

<span class="sd">        This method optimizes the model with the current objective and constraints.</span>
<span class="sd">        After solving, use get_selected_pids() to get the selected pathways or</span>
<span class="sd">        get_solution_summary() for optimization results.</span>

<span class="sd">        Args:</span>
<span class="sd">            verbose: If True, prints a summary of the solution after solving.</span>
<span class="sd">                    Defaults to False.</span>
<span class="sd">            logfile: (str | None, optional) path to a file to log Gurobi output. Defaults to None.</span>

<span class="sd">        Raises:</span>
<span class="sd">            RuntimeError: If the model is infeasible, unbounded, or fails to solve</span>
<span class="sd">                        for any other reason.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">setParam</span><span class="p">(</span><span class="s2">&quot;LogToConsole&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">logfile</span><span class="p">:</span>
            <span class="n">logpath</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">logfile</span><span class="p">)</span>
            <span class="n">logpath</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">setParam</span><span class="p">(</span><span class="s2">&quot;LogFile&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">logpath</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">optimize</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
        <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">Status</span>

        <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="n">gp</span><span class="o">.</span><span class="n">GRB</span><span class="o">.</span><span class="n">INFEASIBLE</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Model is infeasible&quot;</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="n">gp</span><span class="o">.</span><span class="n">GRB</span><span class="o">.</span><span class="n">UNBOUNDED</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Model is unbounded&quot;</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">status</span> <span class="o">!=</span> <span class="n">gp</span><span class="o">.</span><span class="n">GRB</span><span class="o">.</span><span class="n">OPTIMAL</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Optimization failed with status </span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">print_solution_summary</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Save the optimizer state to disk.</span>

<span class="sd">        This method saves:</span>
<span class="sd">        1. The GeoDataFrame to a GeoParquet file</span>
<span class="sd">        2. Model configuration and constraints to a JSON file</span>

<span class="sd">        Args:</span>
<span class="sd">            path: Base path for saving files (without extension).</span>
<span class="sd">                 Will create {path}.geoparquet and {path}.json.</span>

<span class="sd">        Raises:</span>
<span class="sd">            RuntimeError: If model has not been built yet.</span>
<span class="sd">            ValueError: If path is invalid.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;model&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_variables&quot;</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Model has not been built yet. Call build_variables() first.&quot;</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Path cannot be empty&quot;</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># Save GeoDataFrame to GeoParquet</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">to_parquet</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;.geoparquet&quot;</span><span class="p">))</span>

        <span class="c1"># Build constraint schema</span>
        <span class="n">constraint_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="n">ConstraintSchema</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">tag</span><span class="p">:</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_serialize_constraint</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cs</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">tag</span><span class="p">,</span> <span class="n">cs</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_constraints</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span>

        <span class="c1"># Build the full schema</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">OptimizerConfigSchema</span><span class="p">(</span>
            <span class="n">varnames</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_variables</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
            <span class="n">cost_columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cost_columns</span><span class="p">,</span>
            <span class="n">objective</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_objective_weights</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_objective_weights</span>
            <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># HACK</span>
            <span class="n">constraints</span><span class="o">=</span><span class="n">constraint_config</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">path</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;.json&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">model_dump_json</span><span class="p">(</span><span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">debug_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">max_vars</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Print debug information about the current state of the model.</span>

<span class="sd">        Prints basic model information including number of variables,</span>
<span class="sd">        constraints, and model status. If the model has been solved, also</span>
<span class="sd">        includes variable values.</span>

<span class="sd">        Args:</span>
<span class="sd">            verbose: If True, prints additional details about variables</span>
<span class="sd">                    and constraints. Defaults to False.</span>
<span class="sd">            max_vars: Maximum number of variables to print in verbose mode.</span>
<span class="sd">                     Defaults to 20.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Calculate total constraints by handling both single constraints and MConstraints</span>
        <span class="n">total_constraints</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">constr</span><span class="p">)</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">constr</span><span class="p">,</span> <span class="s2">&quot;__len__&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="mi">1</span>
            <span class="k">for</span> <span class="n">constrs</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_constraints</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">constr</span> <span class="ow">in</span> <span class="n">constrs</span>
        <span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Gurobi Model Debug Info&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Variables: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_variables</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Constraints: </span><span class="si">{</span><span class="n">total_constraints</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Objective set: </span><span class="si">{</span><span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_objective_weights</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Model status: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">Status</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_objective_weights</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Objective Weights:&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">col</span><span class="p">,</span> <span class="n">weight</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_objective_weights</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">weight</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Variables (first </span><span class="si">{</span><span class="n">max_vars</span><span class="si">}</span><span class="s2">):&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">varname</span><span class="p">,</span> <span class="n">var</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_variables</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">max_vars</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  ... (truncated)&quot;</span><span class="p">)</span>
                    <span class="k">break</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">varname</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">var</span><span class="o">.</span><span class="n">X</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">SolCount</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;not solved&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Constraint Tags:&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">tag</span><span class="p">,</span> <span class="n">constrs</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_constraints</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="c1"># Count constraints properly for each tag</span>
                <span class="n">tag_total</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="s2">&quot;__len__&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">constrs</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  [</span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="n">tag_total</span><span class="si">}</span><span class="s2"> constraints&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">export_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Export the current model to a human-readable .lp file for debugging.</span>

<span class="sd">        Args:</span>
<span class="sd">            path: Base path for the output file (without extension).</span>
<span class="sd">                 The .lp extension will be added automatically.</span>
<span class="sd">                 Can be either a relative or absolute path.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;.lp&quot;</span><span class="p">)))</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Model written to: </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">.lp&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_register_constraint</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">varnames</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">coeff_map</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
        <span class="n">sense</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>  <span class="c1"># &quot;&lt;=&quot;, &quot;&gt;=&quot;, &quot;==&quot;</span>
        <span class="n">rhs</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">tag</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">defer_update</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">gp</span><span class="o">.</span><span class="n">Constr</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add constraint to Gurobi model.</span>

<span class="sd">        Registers a constraint with the gurobi model, and stores a reference to it.</span>

<span class="sd">        Args:</span>
<span class="sd">            varnames: List of variable names involved in the constraint.</span>
<span class="sd">            coeff_map: Dictionary mapping pid to coefficient.</span>
<span class="sd">            sense: One of &quot;&lt;=&quot;, &quot;&gt;=&quot;, or &quot;==&quot;.</span>
<span class="sd">            rhs: Right-hand-side limit.</span>
<span class="sd">            tag: Optional tag for constraint tracking/removal.</span>
<span class="sd">            defer_update: If False, calls model.update() before exiting. Defaults to False.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The Gurobi constraint object.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If sense is not one of &quot;&lt;=&quot;, &quot;&gt;=&quot;, or &quot;==&quot;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">terms</span> <span class="o">=</span> <span class="p">[</span><span class="n">coeff_map</span><span class="p">[</span><span class="n">vn</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_variables</span><span class="p">[</span><span class="n">vn</span><span class="p">]</span> <span class="k">for</span> <span class="n">vn</span> <span class="ow">in</span> <span class="n">varnames</span><span class="p">]</span>
        <span class="n">expr</span> <span class="o">=</span> <span class="n">gp</span><span class="o">.</span><span class="n">quicksum</span><span class="p">(</span><span class="n">terms</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">sense</span> <span class="o">==</span> <span class="s2">&quot;&lt;=&quot;</span><span class="p">:</span>
            <span class="n">constr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">addConstr</span><span class="p">(</span><span class="n">expr</span> <span class="o">&lt;=</span> <span class="n">rhs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">sense</span> <span class="o">==</span> <span class="s2">&quot;&gt;=&quot;</span><span class="p">:</span>
            <span class="n">constr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">addConstr</span><span class="p">(</span><span class="n">expr</span> <span class="o">&gt;=</span> <span class="n">rhs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">sense</span> <span class="o">==</span> <span class="s2">&quot;==&quot;</span><span class="p">:</span>
            <span class="n">constr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">addConstr</span><span class="p">(</span><span class="n">expr</span> <span class="o">==</span> <span class="n">rhs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Invalid constraint sense: </span><span class="si">{</span><span class="n">sense</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># Store constraint with tag if provided</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_constraints</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">tag</span> <span class="ow">or</span> <span class="s2">&quot;untagged&quot;</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">constr</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">defer_update</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">constr</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_register_matrix_constraint</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">varnames</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">coeffs</span><span class="p">:</span> <span class="n">csr_array</span><span class="p">,</span>
        <span class="n">sense</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>  <span class="c1"># &quot;&lt;=&quot;, &quot;&gt;=&quot;, &quot;==&quot;</span>
        <span class="n">rhs</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">tag</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">defer_update</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">gp</span><span class="o">.</span><span class="n">MConstr</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Register multiple constraints at once using matrix form.</span>

<span class="sd">        This is a more efficient way to add many constraints at once compared to</span>
<span class="sd">        adding them one by one. It uses Gurobi&#39;s matrix constraint API.</span>

<span class="sd">        Args:</span>
<span class="sd">            varnames: List of variable names involved in the constraints.</span>
<span class="sd">            coeffs: Sparse coefficient matrix where each row represents one constraint</span>
<span class="sd">                   and each column corresponds to a pathway variable.</span>
<span class="sd">            sense: One of &quot;&lt;=&quot;, &quot;&gt;=&quot;, or &quot;==&quot;. The sense for all constraints.</span>
<span class="sd">            rhs: Right-hand-side values, one per constraint (row in coeffs).</span>
<span class="sd">            tag: Optional tag for constraint tracking/removal.</span>
<span class="sd">            defer_update: If False, calls model.update() before exiting. Defaults to False.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The Gurobi matrix constraint object.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If sense is not one of &quot;&lt;=&quot;, &quot;&gt;=&quot;, or &quot;==&quot;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sense_map</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;&lt;=&quot;</span><span class="p">:</span> <span class="s2">&quot;&lt;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;&gt;=&quot;</span><span class="p">:</span> <span class="s2">&quot;&gt;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;==&quot;</span><span class="p">:</span> <span class="s2">&quot;=&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">sense</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sense_map</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Invalid constraint sense: </span><span class="si">{</span><span class="n">sense</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sense</span> <span class="o">=</span> <span class="n">sense_map</span><span class="p">[</span><span class="n">sense</span><span class="p">]</span>

        <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_variables</span><span class="p">[</span><span class="n">vn</span><span class="p">]</span> <span class="k">for</span> <span class="n">vn</span> <span class="ow">in</span> <span class="n">varnames</span><span class="p">]</span>

        <span class="n">constrs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">addMConstr</span><span class="p">(</span><span class="n">coeffs</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">sense</span><span class="p">,</span> <span class="n">rhs</span><span class="p">)</span>  <span class="c1"># type: ignore[attr-defined]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_constraints</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">tag</span> <span class="ow">or</span> <span class="s2">&quot;untagged&quot;</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">constrs</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">defer_update</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">constrs</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_serialize_constraint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">constr</span><span class="p">:</span> <span class="n">gp</span><span class="o">.</span><span class="n">Constr</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ConstraintSchema</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Serialize a Gurobi constraint into a schema.</span>

<span class="sd">        Args:</span>
<span class="sd">            constr: The Gurobi constraint to serialize.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The serialized constraint data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">expr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">getRow</span><span class="p">(</span><span class="n">constr</span><span class="p">)</span>
        <span class="n">varnames</span><span class="p">,</span> <span class="n">coeffs</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">size</span><span class="p">()):</span>
            <span class="n">varnames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">getVar</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">VarName</span><span class="p">)</span>
            <span class="n">coeffs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">getCoeff</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>

        <span class="n">sense</span> <span class="o">=</span> <span class="s2">&quot;&lt;=&quot;</span> <span class="k">if</span> <span class="n">constr</span><span class="o">.</span><span class="n">Sense</span> <span class="o">==</span> <span class="s2">&quot;&lt;&quot;</span> <span class="k">else</span> <span class="s2">&quot;&gt;=&quot;</span> <span class="k">if</span> <span class="n">constr</span><span class="o">.</span><span class="n">Sense</span> <span class="o">==</span> <span class="s2">&quot;&gt;&quot;</span> <span class="k">else</span> <span class="s2">&quot;==&quot;</span>

        <span class="k">return</span> <span class="n">ConstraintSchema</span><span class="p">(</span>
            <span class="n">varnames</span><span class="o">=</span><span class="n">varnames</span><span class="p">,</span>
            <span class="n">coeffs</span><span class="o">=</span><span class="n">coeffs</span><span class="p">,</span>
            <span class="n">sense</span><span class="o">=</span><span class="n">sense</span><span class="p">,</span>
            <span class="n">rhs</span><span class="o">=</span><span class="n">constr</span><span class="o">.</span><span class="n">RHS</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_deserialize_and_register_constraint</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">constr</span><span class="p">:</span> <span class="n">ConstraintSchema</span><span class="p">,</span>
        <span class="n">tag</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">gp</span><span class="o">.</span><span class="n">Constr</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Deserialize and register a constraint from a schema.</span>

<span class="sd">        Args:</span>
<span class="sd">            constr: The constraint schema to deserialize.</span>
<span class="sd">            tag: The tag to associate with the constraint.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The registered Gurobi constraint.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">coeff_map</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">constr</span><span class="o">.</span><span class="n">varnames</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span> <span class="n">constr</span><span class="o">.</span><span class="n">coeffs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">constr</span><span class="o">.</span><span class="n">varnames</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_register_constraint</span><span class="p">(</span>
            <span class="n">varnames</span><span class="o">=</span><span class="n">constr</span><span class="o">.</span><span class="n">varnames</span><span class="p">,</span>
            <span class="n">coeff_map</span><span class="o">=</span><span class="n">coeff_map</span><span class="p">,</span>
            <span class="n">sense</span><span class="o">=</span><span class="n">constr</span><span class="o">.</span><span class="n">sense</span><span class="p">,</span>
            <span class="n">rhs</span><span class="o">=</span><span class="n">constr</span><span class="o">.</span><span class="n">rhs</span><span class="p">,</span>
            <span class="n">tag</span><span class="o">=</span><span class="n">tag</span><span class="p">,</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h2 id="urbanopt.PathwayOptimizer.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">gdf</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Initialize the PathwayOptimizer.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>gdf</code>
            </td>
            <td>
                  <code><span title="geopandas.GeoDataFrame">GeoDataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>GeoDataFrame containing pathway data with required columns:
- pid: Pathway identifier (integer)
- label: Pathway type label (e.g., "adu")
- start: Start point/area
- end: End point/area
- desc: Description
- contribution: Contribution score
- geometry: Shapely geometry
- cost_*: Cost-related columns</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If any required columns are missing from the GeoDataFrame,
       or if any pid values are not integers.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>urbanopt\core.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gdf</span><span class="p">:</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize the PathwayOptimizer.</span>

<span class="sd">    Args:</span>
<span class="sd">        gdf: GeoDataFrame containing pathway data with required columns:</span>
<span class="sd">            - pid: Pathway identifier (integer)</span>
<span class="sd">            - label: Pathway type label (e.g., &quot;adu&quot;)</span>
<span class="sd">            - start: Start point/area</span>
<span class="sd">            - end: End point/area</span>
<span class="sd">            - desc: Description</span>
<span class="sd">            - contribution: Contribution score</span>
<span class="sd">            - geometry: Shapely geometry</span>
<span class="sd">            - cost_*: Cost-related columns</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If any required columns are missing from the GeoDataFrame,</span>
<span class="sd">                   or if any pid values are not integers.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Validate required columns</span>
    <span class="n">required_columns</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;pid&quot;</span><span class="p">,</span>
        <span class="s2">&quot;label&quot;</span><span class="p">,</span>
        <span class="s2">&quot;start&quot;</span><span class="p">,</span>
        <span class="s2">&quot;end&quot;</span><span class="p">,</span>
        <span class="s2">&quot;desc&quot;</span><span class="p">,</span>
        <span class="s2">&quot;contribution&quot;</span><span class="p">,</span>
        <span class="s2">&quot;geometry&quot;</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="n">missing_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">required_columns</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">gdf</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">missing_columns</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Missing required columns: </span><span class="si">{</span><span class="n">missing_columns</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># Validate that all PIDs are integers</span>
    <span class="k">if</span> <span class="n">gdf</span><span class="p">[</span><span class="s2">&quot;pid&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="o">!=</span> <span class="s2">&quot;i&quot;</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;All PIDs must be integers&quot;</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># Store a copy of the input data</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># Store CRS</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">crs</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">gdf</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>

    <span class="c1"># Store list of pathway IDs</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">pids</span> <span class="o">=</span> <span class="n">gdf</span><span class="p">[</span><span class="s2">&quot;pid&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

    <span class="c1"># Extract and store cost columns</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">cost_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">gdf</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;cost_&quot;</span><span class="p">)]</span>

    <span class="c1"># Initialize the model</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">gp</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="s2">&quot;pathway_optimizer&quot;</span><span class="p">)</span>

    <span class="c1"># Initialize constraint tracking</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_constraints</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># Initialize objective function</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_objective_weights</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_has_dummies</span> <span class="o">=</span> <span class="kc">False</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="urbanopt.PathwayOptimizer.add_contribution_constraints" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_contribution_constraints</span><span class="p">(</span><span class="n">limits</span><span class="p">,</span> <span class="n">sense</span><span class="p">,</span> <span class="n">boundaries</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Add a constraint limiting the total contribution within a given boundary (or boundaries).</p>
<p>Always returns a matrix constraint.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>limits</code>
            </td>
            <td>
                  <code><span title="float">float</span> | <span title="list">list</span>[<span title="float">float</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum allowed total contribution (or a list of those).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>sense</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>One of "&lt;=", "&gt;=", or "=="</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>boundaries</code>
            </td>
            <td>
                  <code>None | <span title="shapely.geometry.Polygon">Polygon</span> | <span title="shapely.geometry.MultiPolygon">MultiPolygon</span> | <span title="list">list</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional boundary or list of boundaries.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tag</code>
            </td>
            <td>
                  <code><span title="str">str</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional tag for constraint tracking or removal.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="gurobipy.MConstr">MConstr</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A Gurobi matrix constraint object</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="TypeError">TypeError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If boundaries are not valid geometry types.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If number of limits and boundaries do not match.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>urbanopt\core.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_contribution_constraints</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">limits</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
    <span class="n">sense</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">boundaries</span><span class="p">:</span> <span class="kc">None</span> <span class="o">|</span> <span class="n">Polygon</span> <span class="o">|</span> <span class="n">MultiPolygon</span> <span class="o">|</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">tag</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">gp</span><span class="o">.</span><span class="n">MConstr</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add a constraint limiting the total contribution within a given boundary (or boundaries).</span>

<span class="sd">    Always returns a matrix constraint.</span>

<span class="sd">    Args:</span>
<span class="sd">        limits (float | list[float]): Maximum allowed total contribution (or a list of those).</span>
<span class="sd">        sense (str): One of &quot;&lt;=&quot;, &quot;&gt;=&quot;, or &quot;==&quot;</span>
<span class="sd">        boundaries (None | Polygon | MultiPolygon | list, optional): Optional boundary or list of boundaries.</span>
<span class="sd">        tag (str | None, optional): Optional tag for constraint tracking or removal.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A Gurobi matrix constraint object</span>

<span class="sd">    Raises:</span>
<span class="sd">        TypeError: If boundaries are not valid geometry types.</span>
<span class="sd">        ValueError: If number of limits and boundaries do not match.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Coerce inputs to lists</span>
    <span class="k">if</span> <span class="n">boundaries</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">boundaries</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">limits</span><span class="p">,</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">)):</span>
        <span class="n">limits</span> <span class="o">=</span> <span class="p">[</span><span class="n">limits</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">boundaries</span><span class="p">,</span> <span class="p">(</span><span class="n">Polygon</span><span class="p">,</span> <span class="n">MultiPolygon</span><span class="p">)):</span>
        <span class="n">boundaries</span> <span class="o">=</span> <span class="p">[</span><span class="n">boundaries</span><span class="p">]</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">boundaries</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Unsupported boundaries type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">boundaries</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">limits</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">boundaries</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Number of limits must match number of boundaries.&quot;</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">boundaries</span> <span class="o">==</span> <span class="p">[</span><span class="kc">None</span><span class="p">]:</span>
        <span class="c1"># Case 1: No boundary specified: use all pathways</span>
        <span class="n">filtered_pids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pids</span>
        <span class="n">pid_to_group</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">filtered_pids</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># All go into group 0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Case 2: Boundaries specified  spatial join</span>

        <span class="n">boundary_gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span>
            <span class="p">{</span><span class="s2">&quot;limit&quot;</span><span class="p">:</span> <span class="n">limits</span><span class="p">},</span>
            <span class="n">geometry</span><span class="o">=</span><span class="n">boundaries</span><span class="p">,</span>
            <span class="n">crs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">boundary_gdf</span><span class="p">[</span><span class="s2">&quot;group_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">boundary_gdf</span><span class="o">.</span><span class="n">index</span>
        <span class="n">joined</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">sjoin</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[[</span><span class="s2">&quot;pid&quot;</span><span class="p">,</span> <span class="s2">&quot;contribution&quot;</span><span class="p">,</span> <span class="s2">&quot;geometry&quot;</span><span class="p">]],</span>
            <span class="n">boundary_gdf</span><span class="p">[[</span><span class="s2">&quot;group_id&quot;</span><span class="p">,</span> <span class="s2">&quot;geometry&quot;</span><span class="p">]],</span>
            <span class="n">how</span><span class="o">=</span><span class="s2">&quot;inner&quot;</span><span class="p">,</span>
            <span class="n">predicate</span><span class="o">=</span><span class="s2">&quot;intersects&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">joined</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;No pathways intersect the given boundaries.&quot;</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">filtered_pids</span> <span class="o">=</span> <span class="n">joined</span><span class="p">[</span><span class="s2">&quot;pid&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="n">pid_to_group</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="nb">zip</span><span class="p">(</span><span class="n">joined</span><span class="p">[</span><span class="s2">&quot;pid&quot;</span><span class="p">],</span> <span class="n">joined</span><span class="p">[</span><span class="s2">&quot;group_id&quot;</span><span class="p">],</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
        <span class="p">)</span>

    <span class="c1"># Build mapping and sparse matrix</span>
    <span class="n">pid_to_index</span> <span class="o">=</span> <span class="p">{</span><span class="n">pid</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">pid</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">filtered_pids</span><span class="p">)}</span>
    <span class="n">contribution_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;pid&quot;</span><span class="p">)[</span><span class="s2">&quot;contribution&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

    <span class="n">row_indices</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">col_indices</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">pid</span> <span class="ow">in</span> <span class="n">filtered_pids</span><span class="p">:</span>
        <span class="n">col_idx</span> <span class="o">=</span> <span class="n">pid_to_index</span><span class="p">[</span><span class="n">pid</span><span class="p">]</span>
        <span class="n">group_idx</span> <span class="o">=</span> <span class="n">pid_to_group</span><span class="p">[</span><span class="n">pid</span><span class="p">]</span>

        <span class="n">row_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">group_idx</span><span class="p">)</span>
        <span class="n">col_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col_idx</span><span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">contribution_map</span><span class="p">[</span><span class="n">pid</span><span class="p">])</span>

    <span class="n">coeffs</span> <span class="o">=</span> <span class="n">coo_matrix</span><span class="p">(</span>
        <span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="n">row_indices</span><span class="p">,</span> <span class="n">col_indices</span><span class="p">)),</span>
        <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">limits</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">filtered_pids</span><span class="p">)),</span>
    <span class="p">)</span><span class="o">.</span><span class="n">tocsr</span><span class="p">()</span>

    <span class="n">rhs_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">limits</span><span class="p">)</span>

    <span class="n">varnames</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;x_</span><span class="si">{</span><span class="n">pid</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">pid</span> <span class="ow">in</span> <span class="n">filtered_pids</span><span class="p">]</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_register_matrix_constraint</span><span class="p">(</span>
        <span class="n">varnames</span><span class="o">=</span><span class="n">varnames</span><span class="p">,</span>
        <span class="n">coeffs</span><span class="o">=</span><span class="n">coeffs</span><span class="p">,</span>
        <span class="n">sense</span><span class="o">=</span><span class="n">sense</span><span class="p">,</span>
        <span class="n">rhs</span><span class="o">=</span><span class="n">rhs_array</span><span class="p">,</span>
        <span class="n">tag</span><span class="o">=</span><span class="n">tag</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="urbanopt.PathwayOptimizer.add_conversion_constraints" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_conversion_constraints</span><span class="p">(</span><span class="n">start_name</span><span class="p">,</span> <span class="n">sense</span><span class="p">,</span> <span class="n">limit</span><span class="p">,</span> <span class="n">check_overlaps</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">proj_crs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">debuff</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Constrain the sum of pathways that start from a given "start" type.</p>
<p>This method can be used to (e.g.) constrain the total number of pathways that start
from "sfh" to 10, indicating that only 10 sfh can be converted.</p>
<p>If check_overlaps is True, the method attempts to count overlapping pathways
(potentially after a 'debuff') as a single unit in the sum. Otherwise,
it simply constrains the sum of individual selected pathways.</p>


<details class="the-constraint-is-of-the-form" open>
  <summary>The constraint is of the form</summary>
  <p>sum(effective_pathways) [sense] limit</p>
</details>        <p>Where 'effective_pathways' are individual pathways (x_pid) or
indicator variables (z_group) if check_overlaps is True.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>start_name</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>String from self.data["start] to filter on.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>sense</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>One of "&lt;=", "&gt;=", or "==" for the constraint.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>limit</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The right-hand side value for the constraint.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>check_overlaps</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, attempts to identify and group
overlapping pathways. Defaults to False.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>proj_crs</code>
            </td>
            <td>
                  <code><span title="str">str</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A projected CRS to use for geometric
operations (buffer, overlap). Required if self.data CRS is geographic.
Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>debuff</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A distance to shrink pathway geometries by before checking overlaps.
Requires check_overlaps=True. Value must be non-negative. Defaults to 0.</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tag</code>
            </td>
            <td>
                  <code><span title="str">str</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional tag for constraint tracking or removal. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="gurobipy.Constr">Constr</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The Gurobi constraint object added to the model.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If debuff is negative.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If no pathways start from start_name.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If data CRS is geographic and proj_crs is not provided.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>urbanopt\core.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_conversion_constraints</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">start_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">sense</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">check_overlaps</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">proj_crs</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">debuff</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">tag</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">gp</span><span class="o">.</span><span class="n">Constr</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Constrain the sum of pathways that start from a given &quot;start&quot; type.</span>

<span class="sd">    This method can be used to (e.g.) constrain the total number of pathways that start</span>
<span class="sd">    from &quot;sfh&quot; to 10, indicating that only 10 sfh can be converted.</span>

<span class="sd">    If check_overlaps is True, the method attempts to count overlapping pathways</span>
<span class="sd">    (potentially after a &#39;debuff&#39;) as a single unit in the sum. Otherwise,</span>
<span class="sd">    it simply constrains the sum of individual selected pathways.</span>

<span class="sd">    The constraint is of the form:</span>
<span class="sd">        sum(effective_pathways) [sense] limit</span>

<span class="sd">    Where &#39;effective_pathways&#39; are individual pathways (x_pid) or</span>
<span class="sd">    indicator variables (z_group) if check_overlaps is True.</span>

<span class="sd">    Args:</span>
<span class="sd">        start_name (str): String from self.data[&quot;start] to filter on.</span>
<span class="sd">        sense (str): One of &quot;&lt;=&quot;, &quot;&gt;=&quot;, or &quot;==&quot; for the constraint.</span>
<span class="sd">        limit (int): The right-hand side value for the constraint.</span>
<span class="sd">        check_overlaps (bool, optional): If True, attempts to identify and group</span>
<span class="sd">            overlapping pathways. Defaults to False.</span>
<span class="sd">        proj_crs (str | None, optional): A projected CRS to use for geometric</span>
<span class="sd">            operations (buffer, overlap). Required if self.data CRS is geographic.</span>
<span class="sd">            Defaults to None.</span>
<span class="sd">        debuff (float, optional): A distance to shrink pathway geometries by before checking overlaps.</span>
<span class="sd">            Requires check_overlaps=True. Value must be non-negative. Defaults to 0.</span>
<span class="sd">        tag (str | None, optional): Optional tag for constraint tracking or removal. Defaults to None.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The Gurobi constraint object added to the model.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If debuff is negative.</span>
<span class="sd">        ValueError: If no pathways start from start_name.</span>
<span class="sd">        ValueError: If data CRS is geographic and proj_crs is not provided.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Checking arguments</span>
    <span class="k">if</span> <span class="n">debuff</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Value for parameter debuff must be &gt;= 0.&quot;</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">debuff</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">check_overlaps</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Specifying debuff without setting check_overlaps=True will not do anything&quot;</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="n">filtered</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">start_name</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">filtered</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;No pathways start from </span><span class="si">{</span><span class="n">start_name</span><span class="si">}</span><span class="s2">.&quot;</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">proj_crs</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">check_overlaps</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Specifying proj_crs without setting check_overlaps=True will not do anything&quot;</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">proj_crs</span><span class="p">:</span>
        <span class="n">filtered</span> <span class="o">=</span> <span class="n">filtered</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">proj_crs</span><span class="p">)</span>

    <span class="c1"># Get relevant pids</span>
    <span class="k">if</span> <span class="n">check_overlaps</span><span class="p">:</span>
        <span class="n">filtered</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">filtered</span><span class="o">.</span><span class="n">buffer</span><span class="p">(</span><span class="o">-</span><span class="n">debuff</span><span class="p">)</span>

        <span class="n">grph</span> <span class="o">=</span> <span class="n">PolyGraph</span><span class="o">.</span><span class="n">from_geoseries</span><span class="p">(</span>
            <span class="n">filtered</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;pid&quot;</span><span class="p">)[</span><span class="s2">&quot;geometry&quot;</span><span class="p">],</span>  <span class="c1"># type: ignore[arg-type]</span>
            <span class="n">predicate</span><span class="o">=</span><span class="s2">&quot;intersects&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">id_to_cc</span><span class="p">,</span> <span class="n">cc_to_ids</span> <span class="o">=</span> <span class="n">grph</span><span class="o">.</span><span class="n">get_connected_components_map</span><span class="p">()</span>

        <span class="c1"># every pid should be mapped to the set of its connected components</span>
        <span class="n">pids</span> <span class="o">=</span> <span class="p">{</span><span class="n">p</span><span class="p">:</span> <span class="n">cc_to_ids</span><span class="p">[</span><span class="n">id_to_cc</span><span class="p">[</span><span class="n">p</span><span class="p">]]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">filtered</span><span class="p">[</span><span class="s2">&quot;pid&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pids</span> <span class="o">=</span> <span class="p">{</span><span class="n">p</span><span class="p">:</span> <span class="p">{</span><span class="n">p</span><span class="p">}</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">filtered</span><span class="p">[</span><span class="s2">&quot;pid&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())}</span>

    <span class="n">var_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">visited</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">pid</span><span class="p">,</span> <span class="n">overlap_set</span> <span class="ow">in</span> <span class="n">pids</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="c1"># If the pathway doesn&#39;t overlap with anything, just add it by itself</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">overlap_set</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">var_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;x_</span><span class="si">{</span><span class="n">pid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Otherwise we add an auxillary variable</span>
        <span class="k">elif</span> <span class="n">overlap_set</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">visited</span><span class="p">:</span>
            <span class="n">suffix</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">overlap_set</span><span class="p">))</span>
            <span class="n">dummy_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;z_</span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">addVar</span><span class="p">(</span><span class="n">vtype</span><span class="o">=</span><span class="n">gp</span><span class="o">.</span><span class="n">GRB</span><span class="o">.</span><span class="n">BINARY</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">dummy_name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_variables</span><span class="p">[</span><span class="n">dummy_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">z</span>

            <span class="n">constr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">addGenConstrOr</span><span class="p">(</span>
                <span class="n">z</span><span class="p">,</span>
                <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_variables</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;x_</span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">overlap_set</span><span class="p">],</span>
            <span class="p">)</span>

            <span class="n">dummy_tag</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s2">_dummy&quot;</span> <span class="k">if</span> <span class="n">tag</span> <span class="k">else</span> <span class="s2">&quot;dummy&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_constraints</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">dummy_tag</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">constr</span><span class="p">)</span>

            <span class="n">var_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dummy_name</span><span class="p">)</span>
            <span class="n">visited</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">frozenset</span><span class="p">(</span><span class="n">overlap_set</span><span class="p">))</span>

    <span class="n">coeff_map</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">var_list</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_register_constraint</span><span class="p">(</span>
        <span class="n">varnames</span><span class="o">=</span><span class="n">var_list</span><span class="p">,</span>
        <span class="n">coeff_map</span><span class="o">=</span><span class="n">coeff_map</span><span class="p">,</span>
        <span class="n">sense</span><span class="o">=</span><span class="n">sense</span><span class="p">,</span>
        <span class="n">rhs</span><span class="o">=</span><span class="n">limit</span><span class="p">,</span>
        <span class="n">tag</span><span class="o">=</span><span class="n">tag</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="urbanopt.PathwayOptimizer.add_max_contribution_near_point" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_max_contribution_near_point</span><span class="p">(</span><span class="n">limit</span><span class="p">,</span> <span class="n">point</span><span class="p">,</span> <span class="n">distance</span><span class="p">,</span> <span class="n">proj_crs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Add a constraint limiting total contribution for pathways near a point.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>limit</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum allowed total contribution across selected pathways.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>point</code>
            </td>
            <td>
                  <code><span title="shapely.geometry.Point">Point</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Shapely Point to measure distance from.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>distance</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum distance from point to pathway centroid.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>proj_crs</code>
            </td>
            <td>
                  <code><span title="str">str</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional CRS to project geometries into before distance calculation.
 If not provided, uses the current CRS which must be projected.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tag</code>
            </td>
            <td>
                  <code><span title="str">str</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional tag for constraint tracking/removal.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="gurobipy.Constr">Constr</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The created Gurobi constraint object.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If no CRS is provided and current CRS is not projected.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>urbanopt\core.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_max_contribution_near_point</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">limit</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">point</span><span class="p">:</span> <span class="n">Point</span><span class="p">,</span>
    <span class="n">distance</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">proj_crs</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">tag</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">gp</span><span class="o">.</span><span class="n">Constr</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add a constraint limiting total contribution for pathways near a point.</span>

<span class="sd">    Args:</span>
<span class="sd">        limit: Maximum allowed total contribution across selected pathways.</span>
<span class="sd">        point: Shapely Point to measure distance from.</span>
<span class="sd">        distance: Maximum distance from point to pathway centroid.</span>
<span class="sd">        proj_crs: Optional CRS to project geometries into before distance calculation.</span>
<span class="sd">             If not provided, uses the current CRS which must be projected.</span>
<span class="sd">        tag: Optional tag for constraint tracking/removal.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The created Gurobi constraint object.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If no CRS is provided and current CRS is not projected.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># If CRS provided, project data and point</span>
    <span class="k">if</span> <span class="n">proj_crs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">proj_crs</span><span class="p">)</span>
        <span class="n">point</span> <span class="o">=</span> <span class="n">_reproject_point</span><span class="p">(</span><span class="n">point</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span> <span class="n">proj_crs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">crs</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">crs</span><span class="o">.</span><span class="n">is_geographic</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Must provide projected CRS for distance calculation&quot;</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span>

    <span class="c1"># Filter pathways by distance from point to centroid</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">centroid</span><span class="o">.</span><span class="n">distance</span><span class="p">(</span><span class="n">point</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">distance</span>
    <span class="n">filtered_pids</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">mask</span><span class="p">][</span><span class="s2">&quot;pid&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

    <span class="n">coeff_map</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sa">f</span><span class="s2">&quot;x_</span><span class="si">{</span><span class="n">pid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;pid&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">pid</span><span class="p">][</span><span class="s2">&quot;contribution&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">pid</span> <span class="ow">in</span> <span class="n">filtered_pids</span>
    <span class="p">}</span>
    <span class="n">varnames</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">coeff_map</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_register_constraint</span><span class="p">(</span>
        <span class="n">varnames</span><span class="o">=</span><span class="n">varnames</span><span class="p">,</span>
        <span class="n">coeff_map</span><span class="o">=</span><span class="n">coeff_map</span><span class="p">,</span>
        <span class="n">sense</span><span class="o">=</span><span class="s2">&quot;&lt;=&quot;</span><span class="p">,</span>
        <span class="n">rhs</span><span class="o">=</span><span class="n">limit</span><span class="p">,</span>
        <span class="n">tag</span><span class="o">=</span><span class="n">tag</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="urbanopt.PathwayOptimizer.add_mutual_exclusion" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_mutual_exclusion</span><span class="p">(</span><span class="n">label1</span><span class="p">,</span> <span class="n">label2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Add mutual exclusion constraints between pathways based on their labels.</p>
<p>If label2 is provided, creates constraints ensuring no pathway with label1 can be selected with an intersecting pathway with label2.
If label2 is not provided, creates constraints ensuring no pathway with label1 can be selected with ANY intersecting pathway (regardless of label).</p>
<p>Uses GeoPandas spatial join for efficient intersection detection.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>label1</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>First pathway label to find mutual exclusions for.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>label2</code>
            </td>
            <td>
                  <code>(<span title="Optional">Optional</span>, None)</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Pathways with which label1 cannot co-occur. Defaults to None (all pathways)</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tag</code>
            </td>
            <td>
                  <code><span title="str">str</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional tag for constraint tracking/removal.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="gurobipy.MConstr">MConstr</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Gurobi matrix constraint object, or None if no overlaps are found</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>urbanopt\core.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_mutual_exclusion</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">label1</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">label2</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">tag</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">gp</span><span class="o">.</span><span class="n">MConstr</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add mutual exclusion constraints between pathways based on their labels.</span>

<span class="sd">    If label2 is provided, creates constraints ensuring no pathway with label1 can be selected with an intersecting pathway with label2.</span>
<span class="sd">    If label2 is not provided, creates constraints ensuring no pathway with label1 can be selected with ANY intersecting pathway (regardless of label).</span>

<span class="sd">    Uses GeoPandas spatial join for efficient intersection detection.</span>

<span class="sd">    Args:</span>
<span class="sd">        label1: First pathway label to find mutual exclusions for.</span>
<span class="sd">        label2 (Optional, None): Pathways with which label1 cannot co-occur. Defaults to None (all pathways)</span>
<span class="sd">        tag: Optional tag for constraint tracking/removal.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Gurobi matrix constraint object, or None if no overlaps are found</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">label1_paths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">label1</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">label1_paths</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">label2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># i.e., Exclusive with all</span>
        <span class="n">other_paths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">label1</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">other_paths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">label2</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">other_paths</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># Perform spatial join: find intersecting geometry pairs</span>
    <span class="n">joined</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">sjoin</span><span class="p">(</span>
        <span class="n">other_paths</span><span class="p">,</span>
        <span class="n">label1_paths</span><span class="p">,</span>
        <span class="n">how</span><span class="o">=</span><span class="s2">&quot;inner&quot;</span><span class="p">,</span>
        <span class="n">predicate</span><span class="o">=</span><span class="s2">&quot;intersects&quot;</span><span class="p">,</span>
        <span class="n">lsuffix</span><span class="o">=</span><span class="s2">&quot;other&quot;</span><span class="p">,</span>
        <span class="n">rsuffix</span><span class="o">=</span><span class="s2">&quot;label1&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Construct variables</span>
    <span class="n">pids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">joined</span><span class="p">[</span><span class="s2">&quot;pid_label1&quot;</span><span class="p">])</span> <span class="o">|</span> <span class="nb">set</span><span class="p">(</span><span class="n">joined</span><span class="p">[</span><span class="s2">&quot;pid_other&quot;</span><span class="p">]))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">pids</span><span class="p">:</span>  <span class="c1"># No intersecting pathways found</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">index_map</span> <span class="o">=</span> <span class="p">{</span><span class="n">pid</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">pid</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pids</span><span class="p">)}</span>

    <span class="c1"># Construct coefficient matrix</span>
    <span class="n">seen_pairs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">rhs_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">joined</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">pid1</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;pid_label1&quot;</span><span class="p">]</span>
        <span class="n">pid2</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;pid_other&quot;</span><span class="p">]</span>

        <span class="n">key</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">((</span><span class="n">pid1</span><span class="p">,</span> <span class="n">pid2</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">seen_pairs</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">seen_pairs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

        <span class="c1"># Add coefficients for this constraint</span>
        <span class="n">rows</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">rhs_list</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">rhs_list</span><span class="p">)])</span>
        <span class="n">cols</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">index_map</span><span class="p">[</span><span class="n">pid1</span><span class="p">],</span> <span class="n">index_map</span><span class="p">[</span><span class="n">pid2</span><span class="p">]])</span>
        <span class="n">data</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">])</span>  <span class="c1"># Coefficients are 1.0 for both variables</span>
        <span class="n">rhs_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>

    <span class="c1"># Create sparse matrix</span>
    <span class="n">coeffs</span> <span class="o">=</span> <span class="n">coo_matrix</span><span class="p">(</span>
        <span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">)),</span>
        <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rhs_list</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">pids</span><span class="p">)),</span>
    <span class="p">)</span><span class="o">.</span><span class="n">tocsr</span><span class="p">()</span>

    <span class="c1"># Construct the rhs</span>
    <span class="n">rhs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rhs_list</span><span class="p">)</span>

    <span class="c1"># Convert to variable names</span>
    <span class="n">varnames</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;x_</span><span class="si">{</span><span class="n">pid</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">pid</span> <span class="ow">in</span> <span class="n">pids</span><span class="p">]</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_register_matrix_constraint</span><span class="p">(</span>
        <span class="n">varnames</span><span class="o">=</span><span class="n">varnames</span><span class="p">,</span>
        <span class="n">coeffs</span><span class="o">=</span><span class="n">coeffs</span><span class="p">,</span>
        <span class="n">rhs</span><span class="o">=</span><span class="n">rhs</span><span class="p">,</span>
        <span class="n">sense</span><span class="o">=</span><span class="s2">&quot;&lt;=&quot;</span><span class="p">,</span>
        <span class="n">tag</span><span class="o">=</span><span class="n">tag</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="urbanopt.PathwayOptimizer.add_zone_difference_constraints" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_zone_difference_constraints</span><span class="p">(</span><span class="n">geom_pairs</span><span class="p">,</span> <span class="n">sense</span><span class="p">,</span> <span class="n">limits</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Constrain the (absolute) difference in contribution within two geometries within a given limit.</p>
<p>For each pair of geometries (zone1, zone2), enforces:
    sum(contribution in zone1) - sum(contribution in zone2) &lt;= limit
    sum(contribution in zone2) - sum(contribution in zone1) &lt;= limit</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>geom_pairs</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="tuple">tuple</span>[<span title="shapely.geometry.Polygon">Polygon</span> | <span title="shapely.geometry.MultiPolygon">MultiPolygon</span>, <span title="shapely.geometry.Polygon">Polygon</span> | <span title="shapely.geometry.MultiPolygon">MultiPolygon</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of (geom1, geom2) tuples.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>sense</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>One of "&lt;=", "&gt;=", or "=="</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>limits</code>
            </td>
            <td>
                  <code><span title="float">float</span> | <span title="list">list</span>[<span title="float">float</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum allowed total contribution (or a list of those).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tag</code>
            </td>
            <td>
                  <code><span title="str">str</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional tag for constraint tracking or removal.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="tuple">tuple</span>[<span title="gurobipy.MConstr">MConstr</span>, <span title="gurobipy.MConstr">MConstr</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Two Gurobi matrix constraint objects for the absolute difference.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If geom_pairs and limits are not the same length.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>urbanopt\core.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_zone_difference_constraints</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">geom_pairs</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">Polygon</span> <span class="o">|</span> <span class="n">MultiPolygon</span><span class="p">,</span> <span class="n">Polygon</span> <span class="o">|</span> <span class="n">MultiPolygon</span><span class="p">]],</span>
    <span class="n">sense</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">limits</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
    <span class="n">tag</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">gp</span><span class="o">.</span><span class="n">MConstr</span><span class="p">,</span> <span class="n">gp</span><span class="o">.</span><span class="n">MConstr</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Constrain the (absolute) difference in contribution within two geometries within a given limit.</span>

<span class="sd">    For each pair of geometries (zone1, zone2), enforces:</span>
<span class="sd">        sum(contribution in zone1) - sum(contribution in zone2) &lt;= limit</span>
<span class="sd">        sum(contribution in zone2) - sum(contribution in zone1) &lt;= limit</span>

<span class="sd">    Args:</span>
<span class="sd">        geom_pairs: List of (geom1, geom2) tuples.</span>
<span class="sd">        sense (str): One of &quot;&lt;=&quot;, &quot;&gt;=&quot;, or &quot;==&quot;</span>
<span class="sd">        limits (float | list[float]): Maximum allowed total contribution (or a list of those).</span>
<span class="sd">        tag (str | None, optional): Optional tag for constraint tracking or removal.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Two Gurobi matrix constraint objects for the absolute difference.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If geom_pairs and limits are not the same length.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Create GeoDataFrame</span>
    <span class="n">geoms1</span><span class="p">,</span> <span class="n">geoms2</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">geom_pairs</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">geom_pairs</span><span class="p">)))</span>

    <span class="n">gdf1</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span>
        <span class="p">{</span><span class="s2">&quot;row&quot;</span><span class="p">:</span> <span class="n">indices</span><span class="p">,</span> <span class="s2">&quot;side&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="n">geoms1</span><span class="p">},</span>
        <span class="n">crs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">gdf2</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span>
        <span class="p">{</span><span class="s2">&quot;row&quot;</span><span class="p">:</span> <span class="n">indices</span><span class="p">,</span> <span class="s2">&quot;side&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="n">geoms2</span><span class="p">},</span>
        <span class="n">crs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">combined</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span>
        <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">gdf1</span><span class="p">,</span> <span class="n">gdf2</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
        <span class="n">crs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1"># Join with data</span>
    <span class="n">pid_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[[</span><span class="s2">&quot;pid&quot;</span><span class="p">,</span> <span class="s2">&quot;contribution&quot;</span><span class="p">,</span> <span class="s2">&quot;geometry&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">combined</span> <span class="o">=</span> <span class="n">combined</span><span class="o">.</span><span class="n">sjoin</span><span class="p">(</span><span class="n">pid_data</span><span class="p">,</span> <span class="n">predicate</span><span class="o">=</span><span class="s2">&quot;intersects&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
    <span class="n">combined</span> <span class="o">=</span> <span class="n">combined</span><span class="p">[</span><span class="o">~</span><span class="n">combined</span><span class="p">[</span><span class="s2">&quot;contribution&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()]</span>
    <span class="n">combined</span><span class="p">[</span><span class="s2">&quot;pid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">combined</span><span class="p">[</span><span class="s2">&quot;pid&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">combined</span><span class="p">[</span><span class="s2">&quot;index_right&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">combined</span><span class="p">[</span><span class="s2">&quot;index_right&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

    <span class="c1"># Duplicates occur when a pathway is right on a border. We will just drop them</span>
    <span class="c1"># and pretend like they contribute equally to both</span>
    <span class="c1"># HACK</span>
    <span class="n">dupes</span> <span class="o">=</span> <span class="n">combined</span><span class="o">.</span><span class="n">duplicated</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;row&quot;</span><span class="p">,</span> <span class="s2">&quot;pid&quot;</span><span class="p">],</span> <span class="n">keep</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">combined</span> <span class="o">=</span> <span class="n">combined</span><span class="p">[</span><span class="o">~</span><span class="n">dupes</span><span class="p">]</span>

    <span class="c1"># Create maps</span>
    <span class="n">pid_set</span> <span class="o">=</span> <span class="n">combined</span><span class="p">[</span><span class="s2">&quot;pid&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">()</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">pid_to_index</span> <span class="o">=</span> <span class="p">{</span><span class="n">p</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pid_set</span><span class="p">)}</span>
    <span class="n">varnames</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;x_</span><span class="si">{</span><span class="n">pid</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">pid</span> <span class="ow">in</span> <span class="n">pid_set</span><span class="p">]</span>

    <span class="c1"># Construct COO matrix</span>
    <span class="n">row_indices</span> <span class="o">=</span> <span class="n">combined</span><span class="p">[</span><span class="s2">&quot;row&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
    <span class="n">col_indices</span> <span class="o">=</span> <span class="n">combined</span><span class="p">[</span><span class="s2">&quot;pid&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">pid_to_index</span><span class="p">)</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
    <span class="n">combined</span><span class="p">[</span><span class="s2">&quot;coeff&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">combined</span><span class="p">[</span><span class="s2">&quot;contribution&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">combined</span><span class="p">[</span><span class="s2">&quot;side&quot;</span><span class="p">]</span>
    <span class="n">values</span> <span class="o">=</span> <span class="n">combined</span><span class="p">[</span><span class="s2">&quot;coeff&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>

    <span class="n">coeffs</span> <span class="o">=</span> <span class="n">coo_matrix</span><span class="p">(</span>
        <span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="p">(</span><span class="n">row_indices</span><span class="p">,</span> <span class="n">col_indices</span><span class="p">)),</span>
        <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">limits</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">pid_set</span><span class="p">)),</span>
    <span class="p">)</span><span class="o">.</span><span class="n">tocsr</span><span class="p">()</span>

    <span class="n">rhs_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">limits</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

    <span class="c1"># Add both sides of absolute value constraint</span>
    <span class="n">constrs1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_register_matrix_constraint</span><span class="p">(</span>
        <span class="n">varnames</span><span class="o">=</span><span class="n">varnames</span><span class="p">,</span>
        <span class="n">coeffs</span><span class="o">=</span><span class="n">coeffs</span><span class="p">,</span>
        <span class="n">sense</span><span class="o">=</span><span class="n">sense</span><span class="p">,</span>
        <span class="n">rhs</span><span class="o">=</span><span class="n">rhs_array</span><span class="p">,</span>
        <span class="n">tag</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s2">_1&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">constrs2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_register_matrix_constraint</span><span class="p">(</span>
        <span class="n">varnames</span><span class="o">=</span><span class="n">varnames</span><span class="p">,</span>
        <span class="n">coeffs</span><span class="o">=-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">coeffs</span><span class="p">,</span>
        <span class="n">sense</span><span class="o">=</span><span class="n">sense</span><span class="p">,</span>
        <span class="n">rhs</span><span class="o">=</span><span class="n">rhs_array</span><span class="p">,</span>
        <span class="n">tag</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s2">_2&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">constrs1</span><span class="p">,</span> <span class="n">constrs2</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="urbanopt.PathwayOptimizer.build_variables" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">build_variables</span><span class="p">()</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Create binary variables for each pathway and initialize the Gurobi model.</p>
<p>Creates one binary variable per pathway ID and stores them in self._variables.
Also creates and stores the Gurobi model in self.model.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>urbanopt\core.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">build_variables</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create binary variables for each pathway and initialize the Gurobi model.</span>

<span class="sd">    Creates one binary variable per pathway ID and stores them in self._variables.</span>
<span class="sd">    Also creates and stores the Gurobi model in self.model.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Initialize variable tracking</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_variables</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">gp</span><span class="o">.</span><span class="n">Var</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># Initialize index mapping dictionaries</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_gindex_to_pid</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_pid_to_gindex</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># Create binary variables for each pathway</span>
    <span class="k">for</span> <span class="n">pid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pids</span><span class="p">:</span>
        <span class="n">var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">addVar</span><span class="p">(</span><span class="n">vtype</span><span class="o">=</span><span class="n">gp</span><span class="o">.</span><span class="n">GRB</span><span class="o">.</span><span class="n">BINARY</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;x_</span><span class="si">{</span><span class="n">pid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_variables</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;x_</span><span class="si">{</span><span class="n">pid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">var</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_gindex_to_pid</span><span class="p">[</span><span class="n">var</span><span class="o">.</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">pid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pid_to_gindex</span><span class="p">[</span><span class="n">pid</span><span class="p">]</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">index</span>

    <span class="c1"># Update the model to include the new variables</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="urbanopt.PathwayOptimizer.debug_model" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">debug_model</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">max_vars</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Print debug information about the current state of the model.</p>
<p>Prints basic model information including number of variables,
constraints, and model status. If the model has been solved, also
includes variable values.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>verbose</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, prints additional details about variables
    and constraints. Defaults to False.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>max_vars</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum number of variables to print in verbose mode.
     Defaults to 20.</p>
              </div>
            </td>
            <td>
                  <code>20</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>urbanopt\core.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">903</span>
<span class="normal">904</span>
<span class="normal">905</span>
<span class="normal">906</span>
<span class="normal">907</span>
<span class="normal">908</span>
<span class="normal">909</span>
<span class="normal">910</span>
<span class="normal">911</span>
<span class="normal">912</span>
<span class="normal">913</span>
<span class="normal">914</span>
<span class="normal">915</span>
<span class="normal">916</span>
<span class="normal">917</span>
<span class="normal">918</span>
<span class="normal">919</span>
<span class="normal">920</span>
<span class="normal">921</span>
<span class="normal">922</span>
<span class="normal">923</span>
<span class="normal">924</span>
<span class="normal">925</span>
<span class="normal">926</span>
<span class="normal">927</span>
<span class="normal">928</span>
<span class="normal">929</span>
<span class="normal">930</span>
<span class="normal">931</span>
<span class="normal">932</span>
<span class="normal">933</span>
<span class="normal">934</span>
<span class="normal">935</span>
<span class="normal">936</span>
<span class="normal">937</span>
<span class="normal">938</span>
<span class="normal">939</span>
<span class="normal">940</span>
<span class="normal">941</span>
<span class="normal">942</span>
<span class="normal">943</span>
<span class="normal">944</span>
<span class="normal">945</span>
<span class="normal">946</span>
<span class="normal">947</span>
<span class="normal">948</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">debug_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">max_vars</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Print debug information about the current state of the model.</span>

<span class="sd">    Prints basic model information including number of variables,</span>
<span class="sd">    constraints, and model status. If the model has been solved, also</span>
<span class="sd">    includes variable values.</span>

<span class="sd">    Args:</span>
<span class="sd">        verbose: If True, prints additional details about variables</span>
<span class="sd">                and constraints. Defaults to False.</span>
<span class="sd">        max_vars: Maximum number of variables to print in verbose mode.</span>
<span class="sd">                 Defaults to 20.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Calculate total constraints by handling both single constraints and MConstraints</span>
    <span class="n">total_constraints</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
        <span class="nb">len</span><span class="p">(</span><span class="n">constr</span><span class="p">)</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">constr</span><span class="p">,</span> <span class="s2">&quot;__len__&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">constrs</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_constraints</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">constr</span> <span class="ow">in</span> <span class="n">constrs</span>
    <span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Gurobi Model Debug Info&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Variables: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_variables</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Constraints: </span><span class="si">{</span><span class="n">total_constraints</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Objective set: </span><span class="si">{</span><span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_objective_weights</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Model status: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">Status</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_objective_weights</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Objective Weights:&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">col</span><span class="p">,</span> <span class="n">weight</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_objective_weights</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">weight</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Variables (first </span><span class="si">{</span><span class="n">max_vars</span><span class="si">}</span><span class="s2">):&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">varname</span><span class="p">,</span> <span class="n">var</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_variables</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">max_vars</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  ... (truncated)&quot;</span><span class="p">)</span>
                <span class="k">break</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">varname</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">var</span><span class="o">.</span><span class="n">X</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">SolCount</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;not solved&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Constraint Tags:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">tag</span><span class="p">,</span> <span class="n">constrs</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_constraints</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># Count constraints properly for each tag</span>
            <span class="n">tag_total</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="s2">&quot;__len__&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">constrs</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  [</span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="n">tag_total</span><span class="si">}</span><span class="s2"> constraints&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="urbanopt.PathwayOptimizer.export_model" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">export_model</span><span class="p">(</span><span class="n">path</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Export the current model to a human-readable .lp file for debugging.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Base path for the output file (without extension).
 The .lp extension will be added automatically.
 Can be either a relative or absolute path.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>urbanopt\core.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">950</span>
<span class="normal">951</span>
<span class="normal">952</span>
<span class="normal">953</span>
<span class="normal">954</span>
<span class="normal">955</span>
<span class="normal">956</span>
<span class="normal">957</span>
<span class="normal">958</span>
<span class="normal">959</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">export_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Export the current model to a human-readable .lp file for debugging.</span>

<span class="sd">    Args:</span>
<span class="sd">        path: Base path for the output file (without extension).</span>
<span class="sd">             The .lp extension will be added automatically.</span>
<span class="sd">             Can be either a relative or absolute path.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;.lp&quot;</span><span class="p">)))</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Model written to: </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">.lp&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="urbanopt.PathwayOptimizer.get_selected_pids" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_selected_pids</span><span class="p">()</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Get the list of selected pathway IDs from the solved model.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="list">list</span>[<span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A list of pathway IDs that were selected (variable value = 1)</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="RuntimeError">RuntimeError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the model has not been solved yet.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>urbanopt\core.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_selected_pids</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the list of selected pathway IDs from the solved model.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A list of pathway IDs that were selected (variable value = 1)</span>

<span class="sd">    Raises:</span>
<span class="sd">        RuntimeError: If the model has not been solved yet.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">SolCount</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Model has not been solved yet&quot;</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

    <span class="k">return</span> <span class="p">[</span>
        <span class="n">pid</span>
        <span class="k">for</span> <span class="n">pid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pids</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_variables</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;x_</span><span class="si">{</span><span class="n">pid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">X</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span>
        <span class="o">&lt;</span> <span class="mf">1e-6</span>  <span class="c1"># Check if binary variable is 1</span>
    <span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="urbanopt.PathwayOptimizer.get_solution_summary" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_solution_summary</span><span class="p">()</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Get a summary of the optimization results.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>dict</code></td>            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary containing the results with the following keys:</p>
<ul>
<li><strong>objective_value</strong> (float): The final objective value.</li>
<li><strong>total_contribution</strong> (float): Sum of contribution for selected pathways.</li>
<li><strong>solve_time</strong> (float): Time taken to solve the model (seconds).</li>
<li><strong>selected_count</strong> (int): Number of selected pathways.</li>
</ul>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="RuntimeError">RuntimeError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the model has not been solved yet.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>urbanopt\core.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_solution_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get a summary of the optimization results.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: Dictionary containing the results with the following keys:</span>

<span class="sd">            * **objective_value** (float): The final objective value.</span>
<span class="sd">            * **total_contribution** (float): Sum of contribution for selected pathways.</span>
<span class="sd">            * **solve_time** (float): Time taken to solve the model (seconds).</span>
<span class="sd">            * **selected_count** (int): Number of selected pathways.</span>

<span class="sd">    Raises:</span>
<span class="sd">        RuntimeError: If the model has not been solved yet.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">SolCount</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Model has not been solved yet&quot;</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="n">selected_pids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_selected_pids</span><span class="p">()</span>
    <span class="n">filtered</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;pid&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">selected_pids</span><span class="p">)]</span>

    <span class="n">total_contribution</span> <span class="o">=</span> <span class="n">filtered</span><span class="p">[</span><span class="s2">&quot;contribution&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="n">costs</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="p">:</span> <span class="n">filtered</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cost_columns</span><span class="p">}</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;objective_value&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">ObjVal</span><span class="p">,</span>
        <span class="s2">&quot;cost_column_sums&quot;</span><span class="p">:</span> <span class="n">costs</span><span class="p">,</span>
        <span class="s2">&quot;total_contribution&quot;</span><span class="p">:</span> <span class="n">total_contribution</span><span class="p">,</span>
        <span class="s2">&quot;solve_time&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">Runtime</span><span class="p">,</span>
        <span class="s2">&quot;selected_count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">selected_pids</span><span class="p">),</span>
    <span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="urbanopt.PathwayOptimizer.load" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">load</span><span class="p">(</span><span class="n">path</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">

        <p>Load an optimizer from saved files.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>path</code>
            </td>
            <td>
                  <code><span title="str">str</span> | <span title="pathlib.Path">Path</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Base path for loading files (without extension).
 Will look for {path}.geoparquet and {path}.json.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="urbanopt.core.PathwayOptimizer" href="#urbanopt.PathwayOptimizer">PathwayOptimizer</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A new PathwayOptimizer instance with restored state.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="FileNotFoundError">FileNotFoundError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If either file is missing.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If saved state is invalid.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>urbanopt\core.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">load</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;PathwayOptimizer&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Load an optimizer from saved files.</span>

<span class="sd">    Args:</span>
<span class="sd">        path: Base path for loading files (without extension).</span>
<span class="sd">             Will look for {path}.geoparquet and {path}.json.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A new PathwayOptimizer instance with restored state.</span>

<span class="sd">    Raises:</span>
<span class="sd">        FileNotFoundError: If either file is missing.</span>
<span class="sd">        ValueError: If saved state is invalid.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="c1"># Load GeoDataFrame first</span>
    <span class="n">parquet_path</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;.geoparquet&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">parquet_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;GeoParquet file not found: </span><span class="si">{</span><span class="n">parquet_path</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="n">parquet_path</span><span class="p">)</span>

    <span class="c1"># Load and validate config</span>
    <span class="n">json_path</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;.json&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">json_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;JSON configuration file not found: </span><span class="si">{</span><span class="n">json_path</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="n">config_dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">json_path</span><span class="o">.</span><span class="n">read_text</span><span class="p">())</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">OptimizerConfigSchema</span><span class="o">.</span><span class="n">model_validate</span><span class="p">(</span><span class="n">config_dict</span><span class="p">)</span>

    <span class="c1"># Build model</span>
    <span class="n">optimizer</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">optimizer</span><span class="o">.</span><span class="n">build_variables</span><span class="p">()</span>

    <span class="c1"># Restore objective if present</span>
    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">objective</span><span class="p">:</span>
        <span class="n">optimizer</span><span class="o">.</span><span class="n">set_objective</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">objective</span><span class="p">)</span>

    <span class="c1"># Deserialize and restore constraints</span>
    <span class="k">for</span> <span class="n">tag</span><span class="p">,</span> <span class="n">constr_list</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">constraints</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">constr</span> <span class="ow">in</span> <span class="n">constr_list</span><span class="p">:</span>
            <span class="n">optimizer</span><span class="o">.</span><span class="n">_deserialize_and_register_constraint</span><span class="p">(</span><span class="n">constr</span><span class="o">=</span><span class="n">constr</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="n">tag</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">optimizer</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="urbanopt.PathwayOptimizer.print_solution_summary" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">print_solution_summary</span><span class="p">()</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Pretty-print a summary of the optimization results.</p>
<p>Prints a formatted summary including:
- Objective value
- Total contribution of selected pathways
- Solve time in seconds
- Number of selected pathways</p>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="RuntimeError">RuntimeError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the model has not been solved yet.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>urbanopt\core.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">print_solution_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Pretty-print a summary of the optimization results.</span>

<span class="sd">    Prints a formatted summary including:</span>
<span class="sd">    - Objective value</span>
<span class="sd">    - Total contribution of selected pathways</span>
<span class="sd">    - Solve time in seconds</span>
<span class="sd">    - Number of selected pathways</span>

<span class="sd">    Raises:</span>
<span class="sd">        RuntimeError: If the model has not been solved yet.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">summary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_solution_summary</span><span class="p">()</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Optimization Summary&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Objective Value   : </span><span class="si">{</span><span class="n">summary</span><span class="p">[</span><span class="s1">&#39;objective_value&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Total Contribution: </span><span class="si">{</span><span class="n">summary</span><span class="p">[</span><span class="s1">&#39;total_contribution&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Solve Time        : </span><span class="si">{</span><span class="n">summary</span><span class="p">[</span><span class="s1">&#39;solve_time&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> sec&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Selected Pathways : </span><span class="si">{</span><span class="n">summary</span><span class="p">[</span><span class="s1">&#39;selected_count&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="urbanopt.PathwayOptimizer.remove_constraints" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">remove_constraints</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Remove all constraints associated with a given tag.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>tag</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The tag identifying which constraints to remove.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the tag does not exist.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>urbanopt\core.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">remove_constraints</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Remove all constraints associated with a given tag.</span>

<span class="sd">    Args:</span>
<span class="sd">        tag: The tag identifying which constraints to remove.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If the tag does not exist.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">tag</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_constraints</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Tag &#39;</span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s2">&#39; not found in constraints&quot;</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># Remove constraints from model</span>
    <span class="k">for</span> <span class="n">constr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_constraints</span><span class="p">[</span><span class="n">tag</span><span class="p">]:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">constr</span><span class="p">)</span>

    <span class="c1"># Remove constraints from tracking dictionary</span>
    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_constraints</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span>

    <span class="c1"># Update model to reflect changes</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="urbanopt.PathwayOptimizer.save" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">save</span><span class="p">(</span><span class="n">path</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Save the optimizer state to disk.</p>
<p>This method saves:
1. The GeoDataFrame to a GeoParquet file
2. Model configuration and constraints to a JSON file</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>path</code>
            </td>
            <td>
                  <code><span title="str">str</span> | <span title="pathlib.Path">Path</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Base path for saving files (without extension).
 Will create {path}.geoparquet and {path}.json.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="RuntimeError">RuntimeError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If model has not been built yet.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If path is invalid.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>urbanopt\core.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">858</span>
<span class="normal">859</span>
<span class="normal">860</span>
<span class="normal">861</span>
<span class="normal">862</span>
<span class="normal">863</span>
<span class="normal">864</span>
<span class="normal">865</span>
<span class="normal">866</span>
<span class="normal">867</span>
<span class="normal">868</span>
<span class="normal">869</span>
<span class="normal">870</span>
<span class="normal">871</span>
<span class="normal">872</span>
<span class="normal">873</span>
<span class="normal">874</span>
<span class="normal">875</span>
<span class="normal">876</span>
<span class="normal">877</span>
<span class="normal">878</span>
<span class="normal">879</span>
<span class="normal">880</span>
<span class="normal">881</span>
<span class="normal">882</span>
<span class="normal">883</span>
<span class="normal">884</span>
<span class="normal">885</span>
<span class="normal">886</span>
<span class="normal">887</span>
<span class="normal">888</span>
<span class="normal">889</span>
<span class="normal">890</span>
<span class="normal">891</span>
<span class="normal">892</span>
<span class="normal">893</span>
<span class="normal">894</span>
<span class="normal">895</span>
<span class="normal">896</span>
<span class="normal">897</span>
<span class="normal">898</span>
<span class="normal">899</span>
<span class="normal">900</span>
<span class="normal">901</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Save the optimizer state to disk.</span>

<span class="sd">    This method saves:</span>
<span class="sd">    1. The GeoDataFrame to a GeoParquet file</span>
<span class="sd">    2. Model configuration and constraints to a JSON file</span>

<span class="sd">    Args:</span>
<span class="sd">        path: Base path for saving files (without extension).</span>
<span class="sd">             Will create {path}.geoparquet and {path}.json.</span>

<span class="sd">    Raises:</span>
<span class="sd">        RuntimeError: If model has not been built yet.</span>
<span class="sd">        ValueError: If path is invalid.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;model&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_variables&quot;</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Model has not been built yet. Call build_variables() first.&quot;</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Path cannot be empty&quot;</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># Save GeoDataFrame to GeoParquet</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">to_parquet</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;.geoparquet&quot;</span><span class="p">))</span>

    <span class="c1"># Build constraint schema</span>
    <span class="n">constraint_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="n">ConstraintSchema</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">tag</span><span class="p">:</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_serialize_constraint</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cs</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">tag</span><span class="p">,</span> <span class="n">cs</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_constraints</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="c1"># Build the full schema</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">OptimizerConfigSchema</span><span class="p">(</span>
        <span class="n">varnames</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_variables</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
        <span class="n">cost_columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cost_columns</span><span class="p">,</span>
        <span class="n">objective</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_objective_weights</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_objective_weights</span>
        <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># HACK</span>
        <span class="n">constraints</span><span class="o">=</span><span class="n">constraint_config</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">path</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;.json&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">model_dump_json</span><span class="p">(</span><span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="urbanopt.PathwayOptimizer.set_objective" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">set_objective</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Set the optimization objective using weighted costs.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>weights</code>
            </td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="float">float</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary mapping cost column names to their weights.
    Keys must exist in self.cost_columns.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If any weight key is not a valid cost column.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>urbanopt\core.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">set_objective</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weights</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Set the optimization objective using weighted costs.</span>

<span class="sd">    Args:</span>
<span class="sd">        weights: Dictionary mapping cost column names to their weights.</span>
<span class="sd">                Keys must exist in self.cost_columns.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If any weight key is not a valid cost column.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Validate weights</span>
    <span class="n">invalid_weights</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">weights</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cost_columns</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">invalid_weights</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Invalid cost columns in weights: </span><span class="si">{</span><span class="n">invalid_weights</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Available cost columns: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cost_columns</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># Store weights internally</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_objective_weights</span> <span class="o">=</span> <span class="n">weights</span>

    <span class="c1"># Create a dictionary to look up costs faster</span>
    <span class="n">cost_matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;pid&quot;</span><span class="p">)[</span><span class="nb">list</span><span class="p">(</span><span class="n">weights</span><span class="o">.</span><span class="n">keys</span><span class="p">())]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span>
        <span class="n">orient</span><span class="o">=</span><span class="s2">&quot;index&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Precomputing weights per pid saves having to</span>
    <span class="c1"># construct a huge gurobi linear expression</span>
    <span class="n">varnames</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;x_</span><span class="si">{</span><span class="n">pid</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">pid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pids</span><span class="p">]</span>
    <span class="n">weighted_cost</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sa">f</span><span class="s2">&quot;x_</span><span class="si">{</span><span class="n">pid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">*</span> <span class="n">cost_matrix</span><span class="p">[</span><span class="n">pid</span><span class="p">][</span><span class="n">col</span><span class="p">]</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">weights</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">pid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pids</span>
    <span class="p">}</span>

    <span class="n">objective</span> <span class="o">=</span> <span class="n">gp</span><span class="o">.</span><span class="n">quicksum</span><span class="p">(</span>
        <span class="n">weighted_cost</span><span class="p">[</span><span class="n">vn</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_variables</span><span class="p">[</span><span class="n">vn</span><span class="p">]</span> <span class="k">for</span> <span class="n">vn</span> <span class="ow">in</span> <span class="n">varnames</span>
    <span class="p">)</span>

    <span class="c1"># Set as minimization objective</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">setObjective</span><span class="p">(</span><span class="n">objective</span><span class="p">,</span> <span class="n">gp</span><span class="o">.</span><span class="n">GRB</span><span class="o">.</span><span class="n">MINIMIZE</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="urbanopt.PathwayOptimizer.solve" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">solve</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">logfile</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Solve the optimization model.</p>
<p>This method optimizes the model with the current objective and constraints.
After solving, use get_selected_pids() to get the selected pathways or
get_solution_summary() for optimization results.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>verbose</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, prints a summary of the solution after solving.
    Defaults to False.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>logfile</code>
            </td>
            <td>
                  <code><span title="str">str</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>(str | None, optional) path to a file to log Gurobi output. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="RuntimeError">RuntimeError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the model is infeasible, unbounded, or fails to solve
        for any other reason.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>urbanopt\core.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span>
<span class="normal">834</span>
<span class="normal">835</span>
<span class="normal">836</span>
<span class="normal">837</span>
<span class="normal">838</span>
<span class="normal">839</span>
<span class="normal">840</span>
<span class="normal">841</span>
<span class="normal">842</span>
<span class="normal">843</span>
<span class="normal">844</span>
<span class="normal">845</span>
<span class="normal">846</span>
<span class="normal">847</span>
<span class="normal">848</span>
<span class="normal">849</span>
<span class="normal">850</span>
<span class="normal">851</span>
<span class="normal">852</span>
<span class="normal">853</span>
<span class="normal">854</span>
<span class="normal">855</span>
<span class="normal">856</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">solve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">logfile</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Solve the optimization model.</span>

<span class="sd">    This method optimizes the model with the current objective and constraints.</span>
<span class="sd">    After solving, use get_selected_pids() to get the selected pathways or</span>
<span class="sd">    get_solution_summary() for optimization results.</span>

<span class="sd">    Args:</span>
<span class="sd">        verbose: If True, prints a summary of the solution after solving.</span>
<span class="sd">                Defaults to False.</span>
<span class="sd">        logfile: (str | None, optional) path to a file to log Gurobi output. Defaults to None.</span>

<span class="sd">    Raises:</span>
<span class="sd">        RuntimeError: If the model is infeasible, unbounded, or fails to solve</span>
<span class="sd">                    for any other reason.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">setParam</span><span class="p">(</span><span class="s2">&quot;LogToConsole&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">logfile</span><span class="p">:</span>
        <span class="n">logpath</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">logfile</span><span class="p">)</span>
        <span class="n">logpath</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">setParam</span><span class="p">(</span><span class="s2">&quot;LogFile&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">logpath</span><span class="p">))</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">optimize</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
    <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">Status</span>

    <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="n">gp</span><span class="o">.</span><span class="n">GRB</span><span class="o">.</span><span class="n">INFEASIBLE</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Model is infeasible&quot;</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="n">gp</span><span class="o">.</span><span class="n">GRB</span><span class="o">.</span><span class="n">UNBOUNDED</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Model is unbounded&quot;</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">status</span> <span class="o">!=</span> <span class="n">gp</span><span class="o">.</span><span class="n">GRB</span><span class="o">.</span><span class="n">OPTIMAL</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Optimization failed with status </span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">print_solution_summary</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "..", "features": [], "search": "../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.79ae519e.min.js"></script>
      
    
  </body>
</html>